<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-cn">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="ä¸ºäº†æé«˜CPUçš„çš„ä½¿ç”¨ç‡ï¼Œå‡ºç°äº†å¤šçº¿ç¨‹ï¼Œç„¶è€Œå¤šçº¿ç¨‹å½±å“äº†æ•°æ®çš„å®‰å…¨ï¼Œä¸ºäº†ä¿æŠ¤å¤šçº¿ç¨‹ä¸‹çš„æ•°æ®å®‰å…¨ï¼Œå‡ºç°äº†é”çš„æ¦‚å¿µã€‚ç°åœ¨ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹æˆ‘äº†è§£çš„é”â€¦">
<meta property="og:type" content="article">
<meta property="og:title" content="çº¿ç¨‹å®‰å…¨ä¹‹é”">
<meta property="og:url" content="http://yoursite.com/2017/06/11/20170611çº¿ç¨‹å®‰å…¨ä¹‹é”/index.html">
<meta property="og:site_name" content="iKiwi">
<meta property="og:description" content="ä¸ºäº†æé«˜CPUçš„çš„ä½¿ç”¨ç‡ï¼Œå‡ºç°äº†å¤šçº¿ç¨‹ï¼Œç„¶è€Œå¤šçº¿ç¨‹å½±å“äº†æ•°æ®çš„å®‰å…¨ï¼Œä¸ºäº†ä¿æŠ¤å¤šçº¿ç¨‹ä¸‹çš„æ•°æ®å®‰å…¨ï¼Œå‡ºç°äº†é”çš„æ¦‚å¿µã€‚ç°åœ¨ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹æˆ‘äº†è§£çš„é”â€¦">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2019-06-22T03:32:12.588Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="çº¿ç¨‹å®‰å…¨ä¹‹é”">
<meta name="twitter:description" content="ä¸ºäº†æé«˜CPUçš„çš„ä½¿ç”¨ç‡ï¼Œå‡ºç°äº†å¤šçº¿ç¨‹ï¼Œç„¶è€Œå¤šçº¿ç¨‹å½±å“äº†æ•°æ®çš„å®‰å…¨ï¼Œä¸ºäº†ä¿æŠ¤å¤šçº¿ç¨‹ä¸‹çš„æ•°æ®å®‰å…¨ï¼Œå‡ºç°äº†é”çš„æ¦‚å¿µã€‚ç°åœ¨ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹æˆ‘äº†è§£çš„é”â€¦">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/06/11/20170611çº¿ç¨‹å®‰å…¨ä¹‹é”/">





  <title>çº¿ç¨‹å®‰å…¨ä¹‹é” | iKiwi</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">iKiwi</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/11/20170611çº¿ç¨‹å®‰å…¨ä¹‹é”/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangdetong">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="iKiwi">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">çº¿ç¨‹å®‰å…¨ä¹‹é”</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-11T00:00:00+08:00">
                2017-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ä¸ºäº†æé«˜CPUçš„çš„ä½¿ç”¨ç‡ï¼Œå‡ºç°äº†å¤šçº¿ç¨‹ï¼Œç„¶è€Œå¤šçº¿ç¨‹å½±å“äº†æ•°æ®çš„å®‰å…¨ï¼Œä¸ºäº†ä¿æŠ¤å¤šçº¿ç¨‹ä¸‹çš„æ•°æ®å®‰å…¨ï¼Œå‡ºç°äº†é”çš„æ¦‚å¿µã€‚ç°åœ¨ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹æˆ‘äº†è§£çš„é”â€¦</p>
<a id="more"></a>

<p>ä¿¡å·é‡ &amp; é”çš„åŒºåˆ«</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿¡å·é‡ï¼š åŠ é” &amp; é‡Šæ”¾é” å¯ä»¥ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="comment">// é”ï¼š åŠ é” &amp; é‡Šæ”¾é” å¿…é¡»åœ¨åŒä¸€ä¸ªçº¿ç¨‹</span></span><br></pre></td></tr></table></figure>

<h2 id="pthread-mutex-t-äº’æ–¥é”-ï¼ˆæœ€å¸¸ç”¨ï¼‰"><a href="#pthread-mutex-t-äº’æ–¥é”-ï¼ˆæœ€å¸¸ç”¨ï¼‰" class="headerlink" title="pthread_mutex_t(äº’æ–¥é”)ï¼ˆæœ€å¸¸ç”¨ï¼‰"></a>pthread_mutex_t(äº’æ–¥é”)ï¼ˆæœ€å¸¸ç”¨ï¼‰</h2><p>åº”ç”¨åœºæ™¯ï¼šéœ€è¦é”å®šä¸€ä¸ªèµ„æºï¼Œé˜»ç¢å½“å‰çº¿ç¨‹ã€‚æ¯”å¦‚ï¼šå¤šçº¿ç¨‹å¤„ç† global çš„æ•°ç»„ã€‚</p>
<p>ç›¸å…³å‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PTHREAD_MUTEX_INITIALIZER <span class="comment">//åˆå§‹åŒ–çš„å®</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_init(pthread_mutex_t *mp,<span class="keyword">const</span> pthread_mutexattr_t *mattr);</span><br><span class="line"><span class="keyword">int</span> pthread_mutex_lock(pthread_mutex_t *mutex);</span><br><span class="line"><span class="keyword">int</span> pthread_mutex_unlock(pthread_mutex_t *mutex);</span><br><span class="line"><span class="comment">// trylock:ä½¿ç”¨éé˜»å¡äº’æ–¥é”é”å®š (å¦‚æœè·å–äº’æ–¥é”å¤±è´¥ï¼Œå³è¿”å›å€¼ !0,ä¸€èˆ¬ä¸ºEBUSY)</span></span><br><span class="line"><span class="keyword">int</span> pthread_mutex_trylock(pthread_mutex_t *mutex);</span><br><span class="line"><span class="keyword">int</span> pthread_mutex_destroy(pthread_mutex_t *mutex);</span><br><span class="line">é”çš„ç±»å‹æœ‰ï¼šPTHREAD_MUTEX_NORMALã€PTHREAD_MUTEX_ERRORCHECKã€PTHREAD_MUTEX_RECURSIVE ç­‰</span><br><span class="line">pthread_mutex_tä¸­çš„çš„æ–¹æ³•è¿”å›å€¼ï¼Œ<span class="number">0</span>ä»£è¡¨æˆåŠŸï¼Œ<span class="number">1</span>ï¼Œ<span class="number">2</span>â€¦ä»£è¡¨å„ç§é”™è¯¯ï¼ˆEBUZYï¼š<span class="number">16</span>ï¼‰ï¼Œä¿¡å·é‡ ä¸ æ¡ä»¶å˜é‡è¿”å›çš„å€¼<span class="number">0</span> ä¹Ÿä»£è¡¨æˆåŠŸã€‚</span><br><span class="line">å½“OSSpinLockå…¬å¸ƒä¸å®‰å…¨åï¼Œå¤§å®¶å¼€å§‹ä½¿ç”¨pthread_mutex_täº†ï¼Œè§YYMemoryCacheã€PINMemeryCache</span><br></pre></td></tr></table></figure>

<h2 id="pthread-spinlock-t-è‡ªæ—‹é”"><a href="#pthread-spinlock-t-è‡ªæ—‹é”" class="headerlink" title="pthread_spinlock_t(è‡ªæ—‹é”)"></a>pthread_spinlock_t(è‡ªæ—‹é”)</h2><p>ç›¸å…³å‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>   pthread_spin_destroy(pthread_spinlock_t *);</span><br><span class="line"><span class="keyword">int</span>   pthread_spin_init(pthread_spinlock_t *, <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span>   pthread_spin_lock(pthread_spinlock_t *);</span><br><span class="line"><span class="keyword">int</span>   pthread_spin_trylock(pthread_spinlock_t *);</span><br><span class="line"><span class="keyword">int</span>   pthread_spin_unlock(pthread_spinlock_t *);</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°<code>pthread_spinlock_t</code>ä¹‹åæƒ³åˆ°äº†OSSpinLock,ä»¥ä¸ºå†…éƒ¨å°è£…äº†<code>pthread_spinlock_t</code>ï¼Œåœ¨ç½‘ä¸Šæœäº†ä¸€ä¸‹æºç å‘ç°OSSpinLock å†…éƒ¨æ˜¯å°è£…äº†ä¸€ä¸ªå«<code>pthread_lock_t</code>çš„é”ï¼Œè€Œä¸æ˜¯<code>pthread_spinlock_t</code>ï¼Œæˆ‘çŒœæµ‹<code>pthread_lock_t</code>çš„ä¹Ÿæ˜¯å®ç°äº†ç±»ä¼¼<code>pthread_spinlock_t</code>çš„åŠŸèƒ½ã€‚</p>
<p>å…¶å®åœ¨Mac OSä¸­æ˜¯ä¸æ”¯æŒ<code>pthread_spinlock_t</code>çš„ï¼Œåªæ˜¯Linux OS ä¸­æ”¯æŒå®ƒã€‚</p>
<h2 id="â¤ï¸spin-lock-ğŸ†š-mutexâ¤ï¸"><a href="#â¤ï¸spin-lock-ğŸ†š-mutexâ¤ï¸" class="headerlink" title="â¤ï¸spin lock ğŸ†š mutexâ¤ï¸"></a>â¤ï¸spin lock ğŸ†š mutexâ¤ï¸</h2><h3 id="é¢„å¤‡çŸ¥è¯†"><a href="#é¢„å¤‡çŸ¥è¯†" class="headerlink" title="é¢„å¤‡çŸ¥è¯†"></a>é¢„å¤‡çŸ¥è¯†</h3><p>æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ï¼šç°ä»£æ“ä½œç³»ç»Ÿåœ¨ç®¡ç†æ™®é€šçº¿ç¨‹æ—¶ï¼Œé€šå¸¸é‡‡ç”¨æ—¶é—´ç‰‡è½®è½¬ç®—æ³•(Round Robinï¼Œç®€ç§° RR)ã€‚æ¯ä¸ªçº¿ç¨‹ä¼šè¢«åˆ†é…ä¸€æ®µæ—¶é—´ç‰‡(quantum)ï¼Œé€šå¸¸åœ¨ 10-100 æ¯«ç§’å·¦å³ã€‚å½“çº¿ç¨‹ç”¨å®Œå±äºè‡ªå·±çš„æ—¶é—´ç‰‡ä»¥åï¼Œå°±ä¼šè¢«æ“ä½œç³»ç»ŸæŒ‚èµ·ï¼Œæ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è¢«åˆ†é…æ—¶é—´ç‰‡ã€‚</p>
<p>åŸå­æ“ä½œï¼šç‹­ä¹‰ä¸Šçš„åŸå­æ“ä½œè¡¨ç¤ºä¸€æ¡ä¸å¯æ‰“æ–­çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹åœ¨æ‰§è¡Œæ“ä½œè¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«æ“ä½œç³»ç»ŸæŒ‚èµ·ï¼Œè€Œæ˜¯ä¸€å®šä¼šæ‰§è¡Œå®Œã€‚åœ¨å¤šå¤„ç†å™¨çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿè¢«å¤šä¸ªå¤„ç†å™¨åŒæ—¶æ‰§è¡Œçš„æ“ä½œä»»ç„¶ç®—ä¸ä¸ŠåŸå­æ“ä½œã€‚å› æ­¤ï¼ŒçœŸæ­£çš„åŸå­æ“ä½œå¿…é¡»ç”±ç¡¬ä»¶æä¾›æ”¯æŒï¼Œæ¯”å¦‚ x86 å¹³å°ä¸Šå¦‚æœåœ¨æŒ‡ä»¤å‰é¢åŠ ä¸Š â€œLOCKâ€ å‰ç¼€ï¼Œå¯¹åº”çš„æœºå™¨ç åœ¨æ‰§è¡Œæ—¶ä¼šæŠŠæ€»çº¿é”ä½ï¼Œä½¿å¾—å…¶ä»– CPUä¸èƒ½å†æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä»è€Œä»ç¡¬ä»¶å±‚é¢ç¡®ä¿äº†æ“ä½œçš„åŸå­æ€§ã€‚å…¶ä¸­ï¼Œtest_and_setå°±æ˜¯åŸå­æ€§æ“ä½œã€‚</p>
<h3 id="busy-waiting-amp-sleeping"><a href="#busy-waiting-amp-sleeping" class="headerlink" title="busy-waiting &amp; sleeping"></a>busy-waiting &amp; sleeping</h3><blockquote>
<p>ã€ŠAPUEã€‹ä¸­åŸæ–‡æ˜¯è¿™æ ·ï¼šA spin lock is like a mutex, except that instead of blocking a process by sleeping, the process is blocked by busy-waiting (spinning) until the lock can be acquired.</p>
</blockquote>
<p>ä»å®ç°åŸç†ä¸Šæ¥è®²:</p>
<ul>
<li>Mutexå±äºsleep-waitingç±»å‹çš„é”ã€‚</li>
<li>Spin lock å±äºbusy-waitingç±»å‹çš„é”ï¼Œ<h3 id="ä¸¾ä¸ªä¾‹å­"><a href="#ä¸¾ä¸ªä¾‹å­" class="headerlink" title="ä¸¾ä¸ªä¾‹å­"></a>ä¸¾ä¸ªä¾‹å­</h3>ä¾‹å¦‚åœ¨ä¸€ä¸ªåŒæ ¸çš„æœºå™¨ä¸Šæœ‰ä¸¤ä¸ªçº¿ç¨‹(çº¿ç¨‹Aå’Œçº¿ç¨‹B)ï¼Œå®ƒä»¬åˆ†åˆ«è¿è¡Œåœ¨Core0å’ŒCore1ä¸Šã€‚<br>å¦‚æœçº¿ç¨‹Aæƒ³è¦é€šè¿‡pthread_mutex_lockæ“ä½œå»å¾—åˆ°ä¸€ä¸ªä¸´ç•ŒåŒºçš„é”ï¼Œè€Œæ­¤æ—¶è¿™ä¸ªé”æ­£è¢«çº¿ç¨‹Bæ‰€æŒæœ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹Aå°±ä¼šè¢«é˜»å¡(blocking)ï¼Œè®©å‡ºè‡ªå·±çš„æ—¶é—´ç‰‡ï¼ŒCore0 ä¼šåœ¨æ­¤æ—¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢(Context Switch)å°†çº¿ç¨‹Aç½®äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶Core0å°±å¯ä»¥è¿è¡Œå…¶ä»–çš„ä»»åŠ¡(ä¾‹å¦‚å¦ä¸€ä¸ªçº¿ç¨‹C)è€Œä¸å¿…è¿›è¡Œå¿™ç­‰å¾…ã€‚<br>å¦‚æœçº¿ç¨‹Aæ˜¯ä½¿ç”¨pthread_spin_lockæ“ä½œå»è¯·æ±‚é”ï¼Œé‚£ä¹ˆçº¿ç¨‹Aå°±ä¼šä¸€ç›´åœ¨ Core0ä¸Šè¿›è¡Œå¿™ç­‰å¾…å¹¶ä¸åœçš„è¿›è¡Œé”è¯·æ±‚ï¼Œç›´åˆ°å¾—åˆ°è¿™ä¸ªé”ä¸ºæ­¢(ç›´åˆ°ç”¨å®ŒCPUåˆ†é…çš„æ—¶é—´ç‰‡è€Œè¢«ç³»ç»ŸæŒ‚èµ·)ã€‚</li>
</ul>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ï¼ˆ1ï¼‰Mutexé€‚åˆå¯¹é”æ“ä½œéå¸¸é¢‘ç¹çš„åœºæ™¯ï¼Œå¹¶ä¸”å…·æœ‰æ›´å¥½çš„é€‚åº”æ€§ã€‚å°½ç®¡ç›¸æ¯”spin lockå®ƒä¼šèŠ±è´¹æ›´å¤šçš„å¼€é”€ï¼ˆä¸»è¦æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼Œä½†æ˜¯å®ƒèƒ½é€‚åˆå®é™…å¼€å‘ä¸­å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼Œåœ¨ä¿è¯ä¸€å®šæ€§èƒ½çš„å‰æä¸‹æä¾›æ›´å¤§çš„çµæ´»åº¦ã€‚</p>
<p>ï¼ˆ2ï¼‰spin lockçš„lock/unlockæ€§èƒ½æ›´å¥½(èŠ±è´¹æ›´å°‘çš„cpuæŒ‡ä»¤)ï¼Œä½†æ˜¯å®ƒåªé€‚åº”ç”¨äºä¸´ç•ŒåŒºè¿è¡Œæ—¶é—´å¾ˆçŸ­çš„åœºæ™¯ã€‚è€Œåœ¨å®é™…è½¯ä»¶å¼€å‘ä¸­ï¼Œé™¤éç¨‹åºå‘˜å¯¹è‡ªå·±çš„ç¨‹åºçš„é”æ“ä½œè¡Œä¸ºéå¸¸çš„äº†è§£ï¼Œå¦åˆ™ä½¿ç”¨spin lockä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„(é€šå¸¸ä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºä¸­å¯¹é”çš„æ“ä½œæœ‰æ•°ä»¥ä¸‡æ¬¡ï¼Œå¦‚æœå¤±è´¥çš„é”æ“ä½œ(contended lock requests)è¿‡å¤šçš„è¯å°±ä¼šæµªè´¹å¾ˆå¤šçš„æ—¶é—´è¿›è¡Œç©ºç­‰å¾…)ã€‚</p>
<p>ï¼ˆ3ï¼‰æ›´ä¿é™©ï¼ˆä¿å®ˆï¼‰çš„æ–¹æ³•æˆ–è®¸æ˜¯å…ˆä½¿ç”¨ Mutexï¼Œç„¶åå¦‚æœå¯¹æ€§èƒ½è¿˜æœ‰è¿›ä¸€æ­¥çš„éœ€æ±‚ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨spin lockè¿›è¡Œè°ƒä¼˜</p>
<p><strong>ä¸å†å®‰å…¨çš„OSSpinLock</strong><br>OSSpinLockå†…éƒ¨å°è£…äº†pthread_lock_tè€Œä¸æ˜¯pthread_spinlock_tï¼Œæˆ‘çŒœæµ‹æ—¢ç„¶å‘½åä¸ºOSSpinLockï¼Œåº”è¯¥pthread_lock_tçš„ä¹Ÿæ˜¯å®ç°äº†ç±»ä¼¼pthread_spinlock_tçš„åŠŸèƒ½<br>OSSpinLockä¸å®‰å…¨ï¼Œä¸æ˜¯è¯´pthread_spinlock_tä¸å®‰å…¨</p>
<p>åŸå› :åœ¨ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‹¿åˆ°é”æ—¶ï¼Œé«˜ä¼˜å…ˆçº§çº¿ç¨‹è¿›å…¥å¿™ç­‰(busy-wait)çŠ¶æ€ï¼Œæ¶ˆè€—å¤§é‡ CPU æ—¶é—´ï¼Œä»è€Œå¯¼è‡´ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‹¿ä¸åˆ° CPU æ—¶é—´ï¼Œä¹Ÿå°±æ— æ³•å®Œæˆä»»åŠ¡å¹¶é‡Šæ”¾é”ã€‚è¿™ç§é—®é¢˜è¢«ç§°ä¸ºä¼˜å…ˆçº§åè½¬ã€‚æºäºï¼š<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/" target="_blank" rel="noopener">ä¸å†å®‰å…¨çš„ OSSpinLock</a></p>
<p>è§£å†³æ–¹æ¡ˆï¼šå½“å…¬å¸ƒOSSpinLockä¸å®‰å…¨åï¼Œå¤§å®¶çº·çº·è½¬å‘äº†pthread_mutex:<br>æœ‰æ¶ˆæ¯ç§°ï¼Œè‹¹æœåœ¨æ–°ç³»ç»Ÿä¸­å·²ç»ä¼˜åŒ–äº† pthread_mutex çš„æ€§èƒ½ï¼Œæ‰€ä»¥å®ƒçœ‹ä¸Šå»å’Œ OSSpinLock å·®è·å¹¶æ²¡æœ‰é‚£ä¹ˆå¤§äº†ã€‚</p>
<p>facebookçš„KVOControlleråœ¨2016å¹´5æœˆ17æ—¥æ—¶çš„ä¸€ä¸ªCommité‡Œå°†æ‰€æœ‰OSSpinLockæ›¿æ¢æˆäº†pthread_mutexï¼Œå¯å‚çœ‹è¿™ä¸ªcommitã€‚</p>
<p>æŸ¥çœ‹ CoreFoundation çš„æºç èƒ½å¤Ÿå‘ç°ï¼Œè‹¹æœè‡³å°‘åœ¨ 2014 å¹´å°±å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶æŠŠ CoreFoundation ä¸­çš„ spinlock æ›¿æ¢æˆäº† pthread_mutexï¼Œå…·ä½“å˜åŒ–å¯ä»¥æŸ¥çœ‹è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼šCFInternal.h(855.17)ã€CFInternal.h(1151.16)ã€‚è‹¹æœè‡ªå·±å‘ç°é—®é¢˜åï¼Œå¹¶æ²¡æœ‰æ›´æ–° OSSpinLock çš„æ–‡æ¡£ï¼Œä¹Ÿæ²¡æœ‰å‘ŠçŸ¥å¼€å‘è€…ï¼Œè¿™æœ‰äº›è®©äººå¤±æœ›ã€‚</p>
<h2 id="dispatch-semaphore-t-ä¿¡å·é‡"><a href="#dispatch-semaphore-t-ä¿¡å·é‡" class="headerlink" title="dispatch_semaphore_t(ä¿¡å·é‡)"></a>dispatch_semaphore_t(ä¿¡å·é‡)</h2><blockquote>
<p>é€‚ç”¨åœºæ™¯ï¼šæ¯”å¦‚æœ‰3å°æ‰“å°æœºï¼Œæœ‰5ä¸ªçº¿ç¨‹è¦ä½¿ç”¨æ‰“å°æœºï¼Œé‚£ä¹ˆsemaphoreå°±ä¼šå…ˆè®°å½•å¥½æœ‰3å°ï¼Œæ¯æˆåŠŸè¢«ç”³è¯·ä¸€æ¬¡ï¼Œå°±å‡1ï¼Œå‡åˆ°0æ—¶ï¼Œåé¢çš„ç”³è¯·å°±ä¼šè¢«æ‹’ç»ã€‚</p>
</blockquote>
<p>semaphoreä¸å±äºé”çš„èŒƒç•´ï¼Œä¸è¿‡å½“æŠŠsemaphore çš„èµ„æºæ•°é‡ä¸º 0 å³ dispatch_semaphore_create(0)æ—¶ï¼Œå°±å¯ä»¥å½“åšmutexä½¿ç”¨äº†</p>
<h3 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="headerlink" title="ç›¸å…³å‡½æ•°"></a>ç›¸å…³å‡½æ•°</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//value:ä¿¡å·é‡,å³å¯ç”¨èµ„æºçš„æ•°é‡</span></span><br><span class="line">dispatch_semaphore_t  dispatch_semaphore_create(<span class="keyword">long</span> value);</span><br><span class="line"><span class="comment">// å½“è¿”å›å€¼ä¸º0æ—¶è¡¨ç¤ºå½“å‰å¹¶æ²¡æœ‰çº¿ç¨‹ç­‰å¾…å…¶å¤„ç†çš„ä¿¡å·é‡ï¼Œå…¶å¤„ç†çš„ä¿¡å·é‡çš„å€¼åŠ 1å³å¯ã€‚</span></span><br><span class="line"><span class="comment">// å½“è¿”å›å€¼ä¸ä¸º0æ—¶ï¼Œè¡¨ç¤ºå…¶å½“å‰æœ‰ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰çº¿ç¨‹ç­‰å¾…å…¶å¤„ç†çš„ä¿¡å·é‡ï¼Œå¹¶ä¸”è¯¥å‡½æ•°å”¤é†’äº†ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">long</span> dispatch_semaphore_signal(dispatch_semaphore_t dsema)</span><br><span class="line"><span class="comment">// å½“å…¶è¿”å›0æ—¶è¡¨ç¤ºåœ¨timeoutä¹‹å‰ï¼Œè¯¥å‡½æ•°æ‰€å¤„çš„çº¿ç¨‹è¢«æˆåŠŸå”¤é†’ã€‚</span></span><br><span class="line"><span class="comment">// å½“å…¶è¿”å›ä¸ä¸º0æ—¶ï¼Œè¡¨ç¤ºtimeoutå‘ç”Ÿã€‚</span></span><br><span class="line"><span class="keyword">long</span> dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout)ï¼›</span><br></pre></td></tr></table></figure>

<h3 id="å…³äºä¿¡å·é‡ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœè½¦æ¥æ¯”å–»"><a href="#å…³äºä¿¡å·é‡ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœè½¦æ¥æ¯”å–»" class="headerlink" title="å…³äºä¿¡å·é‡ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœè½¦æ¥æ¯”å–»"></a>å…³äºä¿¡å·é‡ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœè½¦æ¥æ¯”å–»</h3><p>åœè½¦åœºå‰©ä½™4ä¸ªè½¦ä½ï¼Œé‚£ä¹ˆå³ä½¿åŒæ—¶æ¥äº†å››è¾†è½¦ä¹Ÿèƒ½åœçš„ä¸‹ã€‚å¦‚æœæ­¤æ—¶æ¥äº†äº”è¾†è½¦ï¼Œé‚£ä¹ˆå°±æœ‰ä¸€è¾†éœ€è¦ç­‰å¾…ã€‚ä¿¡å·é‡çš„å€¼å°±ç›¸å½“äºå‰©ä½™è½¦ä½çš„æ•°ç›®ï¼Œdispatch_semaphore_waitå‡½æ•°å°±ç›¸å½“äºæ¥äº†ä¸€è¾†è½¦ï¼Œdispatch_semaphore_signalå°±ç›¸å½“äºèµ°äº†ä¸€è¾†è½¦ã€‚åœè½¦ä½çš„å‰©ä½™æ•°ç›®åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±å·²ç»æŒ‡æ˜äº†ï¼ˆdispatch_semaphore_createï¼ˆlong valueï¼‰ï¼‰ï¼Œè°ƒç”¨ä¸€æ¬¡dispatch_semaphore_signalï¼Œå‰©ä½™çš„è½¦ä½å°±å¢åŠ ä¸€ä¸ªï¼›è°ƒç”¨ä¸€æ¬¡dispatch_semaphore_waitå‰©ä½™è½¦ä½å°±å‡å°‘ä¸€ä¸ªï¼›å½“å‰©ä½™è½¦ä½ä¸º0æ—¶ï¼Œå†æ¥è½¦ï¼ˆå³è°ƒç”¨dispatch_semaphore_waitï¼‰å°±åªèƒ½ç­‰å¾…ã€‚æœ‰å¯èƒ½åŒæ—¶æœ‰å‡ è¾†è½¦ç­‰å¾…ä¸€ä¸ªåœè½¦ä½ã€‚æœ‰äº›è½¦ä¸»æ²¡æœ‰è€å¿ƒï¼Œç»™è‡ªå·±è®¾å®šäº†ä¸€æ®µç­‰å¾…æ—¶é—´ï¼Œè¿™æ®µæ—¶é—´å†…ç­‰ä¸åˆ°åœè½¦ä½å°±èµ°äº†ï¼Œå¦‚æœç­‰åˆ°äº†å°±å¼€è¿›å»åœè½¦ã€‚è€Œæœ‰äº›è½¦ä¸»å°±åƒæŠŠè½¦åœåœ¨è¿™ï¼Œæ‰€ä»¥å°±ä¸€ç›´ç­‰ä¸‹å»ã€‚</p>
<h2 id="semaphore-ä¾‹å­-é˜»ç¢å½“å‰çº¿ç¨‹"><a href="#semaphore-ä¾‹å­-é˜»ç¢å½“å‰çº¿ç¨‹" class="headerlink" title="semaphore ä¾‹å­(é˜»ç¢å½“å‰çº¿ç¨‹)"></a>semaphore ä¾‹å­(é˜»ç¢å½“å‰çº¿ç¨‹)</h2><h3 id="å…³äºdispatch-semaphoreçš„ä½¿ç”¨"><a href="#å…³äºdispatch-semaphoreçš„ä½¿ç”¨" class="headerlink" title="å…³äºdispatch_semaphoreçš„ä½¿ç”¨"></a>å…³äºdispatch_semaphoreçš„ä½¿ç”¨</h3><p>å½“ç„¶demoä¸­çš„semaphoreå¯ä»¥æ¢æˆpthread_mutex_tï¼ŒğŸ‘‡ä¸¤ä¸ªä¾‹å­ä¸€å®šè¦ç¡®ä¿ blocké‡Œé¢æ˜¯åœ¨å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå¦åˆ™ä¼šå‡ºç°æ­»é”ï¼ï¼ï¼âš ï¸</p>
<p>å…¶ä¸­ TMCacheä¸­çš„åŒæ­¥è·å–æ•°æ®å°±æ˜¯ å†…éƒ¨è°ƒç”¨å¼‚æ­¥æ¥å£é€šè¿‡semaphoreå¤„ç†æ•°æ®åŒæ­¥çš„</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æŠŠå¼‚æ­¥è¿”å›æ•°æ® åŒæ­¥åˆ°å½“å‰çº¿ç¨‹</span></span><br><span class="line">   dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">   [HttpManager requestDemoWithBolck:^(<span class="built_in">NSDictionary</span> *dic)&#123;</span><br><span class="line">	       dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;]</span><br><span class="line">   dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br></pre></td></tr></table></figure>

<p>çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­ï¼šå…³äº AFN çš„ AFURLSessionManagerä¸­çš„</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span> *)tasksForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    __block <span class="built_in">NSArray</span> *tasks = <span class="literal">nil</span>;</span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</span><br><span class="line">		<span class="comment">// çœç•¥...</span></span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;];</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="signal-amp-wait-æˆå¯¹å‡ºç°"><a href="#signal-amp-wait-æˆå¯¹å‡ºç°" class="headerlink" title="signal &amp; wait æˆå¯¹å‡ºç°"></a>signal &amp; wait æˆå¯¹å‡ºç°</h3><p>ä½¿ç”¨signalä»¥ç¡®ä¿ç¼–è¯‘å™¨releaseæ‰dispatch_semaphore_tæ—¶çš„valueä¸åˆå§‹å€¼ä¸€è‡´ï¼ˆdispatch_semaphore_signal &amp; dispatch_semaphore_waitæˆå¯¹å‡ºç°ï¼‰ï¼Œ å¦åˆ™ä¼šEXC_BAD_INSTRUCTION</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test_semaphore_wait_signal&#123;</span><br><span class="line">    <span class="comment">// dispatch_semaphore_create çš„å‚æ•°æ˜¯ä¿¡å·é‡çš„ åˆå§‹å€¼</span></span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        dispatch_time_t t = dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span>*<span class="number">1000</span>*<span class="number">1000</span>*<span class="number">1000</span>);<span class="comment">//2ç§’</span></span><br><span class="line">        <span class="keyword">if</span> (dispatch_semaphore_wait(semaphore, t) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"success , i=%d"</span>,i);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"timeout , i=%d"</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"end"</span>);</span><br><span class="line">    <span class="comment">//æ³¨é‡Šæ‰ä¸‹é¢çš„ä»£ç ï¼Œå¯¼è‡´ä¿¡å·é‡ä¸åˆå§‹å€¼ä¸ä¸€è‡´ï¼Œ ä¼šEXC_BAD_INSTRUCTION</span></span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»æµ‹è¯•å‘ç°ï¼Œå½“ä¿¡å·é‡çš„value &lt; åˆå§‹å€¼ä¼š crashï¼Œè€Œå½“ ä¿¡å·é‡çš„value &gt; åˆå§‹å€¼æ—¶æ­£å¸¸ä¸crashã€‚<br>æ‰“å°ä¸€ä¸‹semaphore:ä¸»è¦çœ‹å®ƒçš„ value &amp; orig</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;OS_dispatch_semaphore: semaphore[0x6080002819f0] = &#123; xrefcnt = 0x1, refcnt = 0x1, port = 0x0, value = 4, orig = 5 &#125;&gt;</span><br></pre></td></tr></table></figure>

<h2 id="pthread-cond-t-æ¡ä»¶å˜é‡"><a href="#pthread-cond-t-æ¡ä»¶å˜é‡" class="headerlink" title="pthread_cond_t(æ¡ä»¶å˜é‡)"></a>pthread_cond_t(æ¡ä»¶å˜é‡)</h2><p>åœºæ™¯ï¼š(ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼)Bçº¿ç¨‹å’ŒAçº¿ç¨‹ä¹‹é—´æœ‰åˆä½œå…³ç³»ï¼Œå½“Açº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ä¹‹å‰ï¼ŒBçº¿ç¨‹ä¼šç­‰å¾…ã€‚å½“Açº¿ç¨‹å®ŒæˆæŸä»¶äº‹æƒ…ä¹‹åï¼Œéœ€è¦è®©Bçº¿ç¨‹çŸ¥é“ï¼Œç„¶åBçº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€ä¸­è¢«å”¤é†’ï¼Œç„¶åç»§ç»­åšè‡ªå·±è¦åšçš„äº‹æƒ…ã€‚</p>
<p>âš ï¸æ¡ä»¶å˜é‡å¿…é¡»è¦è·Ÿäº’æ–¥é”è”åˆèµ·æ¥ç”¨âš ï¸<br>ç›¸å…³å‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PTHREAD_COND_INITIALIZER</span><br><span class="line"><span class="keyword">int</span> pthread_cond_init(pthread_cond_t *restrict cond, <span class="keyword">const</span> pthread_condattr_t *restrict attr);</span><br><span class="line"><span class="keyword">int</span> pthread_cond_destroy(pthread_cond_t *cond);</span><br><span class="line"><span class="keyword">int</span> pthread_cond_signal(pthread_cond_t *cond);<span class="comment">//é€šçŸ¥ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">int</span> pthread_cond_broadcast(pthread_cond_t *cond); <span class="comment">//é€šçŸ¥æ‰€ä»¥waitçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">int</span> pthread_cond_wait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex);</span><br><span class="line"><span class="keyword">int</span> pthread_cond_timedwait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex, <span class="keyword">const</span> <span class="keyword">struct</span> timespec *restrict abstime);</span><br></pre></td></tr></table></figure>

<p>ç®€å•æµ‹è¯•ä¸€ä¸‹signal &amp; broadcast åŒºåˆ«</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test_condition_variable&#123;</span><br><span class="line">    pthread_cond_init(&amp;condition_variable_signal, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weak_self = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">            [weak_self test_pthread_cond_wait:i];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//// æµ‹è¯• å¾—signalåï¼Œé€šçŸ¥çš„ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸æ˜¯ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹</span></span><br><span class="line"><span class="comment">//    dispatch_async(dispatch_get_global_queue(2, 0), ^&#123;</span></span><br><span class="line"><span class="comment">//        [weak_self test_pthread_cond_wait:9999];</span></span><br><span class="line"><span class="comment">//    &#125;);</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//        [weak_self test_pthread_cond_signal];</span></span><br><span class="line">        [weak_self test_pthread_cond_broadcast];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)test_pthread_cond_wait:(<span class="built_in">NSInteger</span> )i&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="keyword">while</span> (name.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"before wait i:%ld"</span>,i);</span><br><span class="line">        pthread_cond_wait(&amp;condition_variable_signal, &amp;mutex);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"after wait i:%ld"</span>,i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"get:name = %@ and i:%ld"</span>,name,i);</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)test_pthread_cond_signal &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    name = <span class="string">@"wangdt"</span>;</span><br><span class="line">    pthread_cond_signal(&amp;condition_variable_signal);<span class="comment">//äº‹æƒ…åšå®Œäº†ä¹‹åè¦æ‰”ä¿¡å·ç»™ç­‰å¾…çš„çº¿ç¨‹å‘Šè¯‰ä»–ä»¬åšå®Œäº†</span></span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"set:name = %@"</span>,name);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)test_pthread_cond_broadcast &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    name = <span class="string">@"wangdt"</span>;</span><br><span class="line">    pthread_cond_broadcast(&amp;condition_variable_signal);<span class="comment">//äº‹æƒ…åšå®Œäº†ä¹‹åè¦æ‰”ä¿¡å·ç»™ç­‰å¾…çš„çº¿ç¨‹å‘Šè¯‰ä»–ä»¬åšå®Œäº†</span></span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"set:name = %@"</span>,name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…demo"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…demo" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…demo"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…demo</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> consumer () &#123; <span class="comment">// æ¶ˆè´¹è€…  </span></span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="keyword">while</span> (data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pthread_cond_wait(&amp;condition_variable_signal, &amp;mutex); <span class="comment">// ç­‰å¾…æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// --- æœ‰æ–°çš„æ•°æ®ï¼Œä»¥ä¸‹ä»£ç è´Ÿè´£å¤„ç† â†“â†“â†“â†“â†“â†“</span></span><br><span class="line">    <span class="comment">// temp = data;</span></span><br><span class="line">    <span class="comment">// --- æœ‰æ–°çš„æ•°æ®ï¼Œä»¥ä¸Šä»£ç è´Ÿè´£å¤„ç† â†‘â†‘â†‘â†‘â†‘â†‘</span></span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> producer () &#123;  </span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="comment">// ç”Ÿäº§æ•°æ®</span></span><br><span class="line">   <span class="comment">// data = â€¦;</span></span><br><span class="line">    pthread_cond_signal(&amp;condition_variable_signal); <span class="comment">// å‘å‡ºä¿¡å·ç»™æ¶ˆè´¹è€…ï¼Œå‘Šè¯‰ä»–ä»¬æœ‰äº†æ–°çš„æ•°æ®</span></span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¸ºä»€ä¹ˆéœ€è¦é…åˆpthread-mutex-lockï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦é…åˆpthread-mutex-lockï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦é…åˆpthread_mutex_lockï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦é…åˆpthread_mutex_lockï¼Ÿ</h4><p>å› ä¸ºï¼Œæˆ‘ä»¬åŠ é”çš„æœ€åˆåŸå› æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„çº¿ç¨‹å®‰å…¨ï¼Œé…åˆmutexçš„ç›®çš„ä¹Ÿå°±æ˜¯ä¸ºäº†ä¿è¯ dataçš„å®‰å…¨</p>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦-while-è€Œä¸æ˜¯-if-ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦-while-è€Œä¸æ˜¯-if-ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ while è€Œä¸æ˜¯ if ï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦ while è€Œä¸æ˜¯ if ï¼Ÿ</h4><p>å¦‚æœå‘å‡ºpthread_cond_signalï¼Œçº¿ç¨‹ä»pthread_cond_waitå”¤é†’ï¼Œåœ¨pthread_cond_waitæœªè¿”å›ä¹‹å‰ï¼Œå¦‚æœæœ‰åˆ«äººå†™ä¸€ä¸ªçº¿ç¨‹å»æŠŠè¿™ä¸ªdataææˆNULLäº†ï¼ŒæœŸé—´æ²¡æœ‰ç”³è¯·mutexé”ã€‚é‚£ä¹ˆpthread_cond_waitåº”è¯¥ä¸èƒ½è¢«å”¤é†’ï¼Œè¿˜å¾—ç»§ç»­ç­‰å¾…ï¼Œä½†æ˜¯ if{}ä¸ä¼šå†æ¬¡åˆ¤æ–­dataçš„å€¼ï¼Œè€Œwhileå¯ä»¥å†æ¬¡åˆ¤æ–­ï¼</p>
<h2 id="Objective-Cä¸­çš„é”"><a href="#Objective-Cä¸­çš„é”" class="headerlink" title="Objective-Cä¸­çš„é”"></a>Objective-Cä¸­çš„é”</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSLocking</span></span></span><br><span class="line">- (<span class="keyword">void</span>)lock;</span><br><span class="line">- (<span class="keyword">void</span>)unlock;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>å®ƒä»¬éƒ½å®ç°äº†NSLockingåè®®ï¼šNSLockã€NSRecursiveLockã€NSConditionã€NSConditionLock</p>
<h3 id="NSCondition"><a href="#NSCondition" class="headerlink" title="NSCondition"></a>NSCondition</h3><p>å®ç°åŸç†ï¼šå°è£…äº†ä¸€ä¸ªäº’æ–¥é”å’Œæ¡ä»¶å˜é‡ï¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test_NSCondition &#123;</span><br><span class="line">    <span class="built_in">NSCondition</span>* lock = [[<span class="built_in">NSCondition</span> alloc] init];</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"before broadcast i:%d"</span>,i);</span><br><span class="line">                [lock lock];</span><br><span class="line">                [lock signal];</span><br><span class="line"><span class="comment">//                [lock broadcast];</span></span><br><span class="line">                [lock unlock];</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"after broadcast i:%d"</span>,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"before wait"</span>);</span><br><span class="line">        [lock lock];</span><br><span class="line">        [lock wait];</span><br><span class="line">        [lock unlock];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"after wait"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NSConditionLock"><a href="#NSConditionLock" class="headerlink" title="NSConditionLock"></a>NSConditionLock</h3><p>å®ç°åŸç†ï¼šå†…éƒ¨æŒæœ‰ä¸€ä¸ª NSCondition å¯¹è±¡ï¼Œå®ƒçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚â€œæ¡ä»¶è¢«æ»¡è¶³â€å¯ä»¥ç†è§£ä¸ºç”Ÿäº§è€…æä¾›äº†æ–°çš„å†…å®¹ã€‚åœ¨PINCacheä¸­çš„PINDiskCacheä½¿ç”¨äº†NSConditionLock</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define kBegin 0</span></span><br><span class="line"><span class="meta">#define kEnd 1</span></span><br><span class="line">- (<span class="keyword">void</span>)test_NSConditionLock&#123;</span><br><span class="line">    <span class="built_in">NSConditionLock</span> *conditionLock = [[<span class="built_in">NSConditionLock</span> alloc] initWithCondition:kBegin];<span class="comment">// åˆå§‹åŒ–çŠ¶æ€ä¸º kBegin</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"1"</span>);</span><br><span class="line">        [conditionLock lock];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"2"</span>);</span><br><span class="line">        <span class="comment">// - (void)unlockWithCondition:(NSInteger)condition; //è§£é”ï¼Œå¹¶ä¸”è®¾ç½®lock.condition = condition</span></span><br><span class="line">        [conditionLock unlockWithCondition:kEnd];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"3"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"4"</span>);</span><br><span class="line">    <span class="comment">// - (void)lockWhenCondition:(NSInteger)condition; //conditionä¸å†…éƒ¨ç›¸åŒæ‰ä¼šè·å–é”å¯¹è±¡å¹¶ç«‹å³è¿”å›ï¼Œå¦åˆ™é˜»å¡çº¿ç¨‹ç›´åˆ°conditionç›¸åŒ</span></span><br><span class="line">    [conditionLock lockWhenCondition:kEnd];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"5"</span>);</span><br><span class="line">    [conditionLock unlock];</span><br><span class="line">    conditionLock = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"finished"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NSLock"><a href="#NSLock" class="headerlink" title="NSLock"></a>NSLock</h3><p>NSLock åªæ˜¯åœ¨å†…éƒ¨å°è£…äº†ä¸€ä¸ªå±æ€§ä¸º PTHREAD_MUTEX_ERRORCHECKçš„ pthread_mutex</p>
<p>âš ï¸NSLockçš„lock &amp; unlock å¿…é¡»åœ¨åŒä¸€ä¸ªçº¿ç¨‹(<a href="https://developer.apple.com/reference/foundation/nslock" target="_blank" rel="noopener">https://developer.apple.com/reference/foundation/nslock</a>)
trylockçš„è¿”å›å€¼ï¼šYESä»£è¡¨æˆåŠŸï¼ŒNOä»£è¡¨å¤±è´¥ï¼Œé¿å…ä¸åº•å±‚çš„å‡½æ•°è¿”å›æ··æ·†ï¼ˆpthread_mutex_tç›¸å…³å‡½æ•°è¿”å› 0 ä»£è¡¨æˆåŠŸï¼Œ!0ä»£è¡¨å¤±è´¥ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLock</span> *theLock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">[theLock lock];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">	[theLock unlock];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é”™è¯¯æç¤ºï¼š * -[NSLock unlock]: lock ( â€˜(null)â€™) unlocked from thread which did not lock it</p>
</blockquote>
<h3 id="NSRecursiveLock"><a href="#NSRecursiveLock" class="headerlink" title="NSRecursiveLock"></a>NSRecursiveLock</h3><p>NSRecursiveLock å†…éƒ¨å°è£…äº†ä¸€ä¸ªå±æ€§ä¸º PTHREAD_MUTEX_RECURSIVEçš„ pthread_mutexã€‚<br>é€’å½’é”å…è®¸é€’å½’è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯lockå¤šæ¬¡ï¼Œåªæ˜¯å­˜åœ¨ä¸€ä¸ªè®¡æ•°å™¨ç´¯åŠ 1ï¼Œç­‰åˆ°unlockçš„æ—¶å€™ï¼Œå°†è®¡æ•°å™¨é€’å‡1ã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜ï¼š<br>åœ¨ YYThreadSafeArray ä¸­çš„é”ç±»å‹æ˜¯èµ„æºä¸º 1 çš„dispatch_semaphore_t (ä¹‹å‰æ˜¯OSSpinLock) ã€‚åœ¨ä½¿ç”¨YYThreadSafeArrayæ—¶ï¼Œå¦‚æœåœ¨enumerateObjectsUsingBlocké‡Œé¢å†è°ƒç”¨array.countçš„è¯ YYThreadSafeArray ä¼šæ­»é”ï¼ŒenumerateObjectsUsingBlockä¸Šæœ‰lock ï¼Œcountä¹Ÿæœ‰lockäº†ï¼Œæ‰€ä»¥é€ æˆäº†æ­»é”ã€‚<br>å¦‚æœæŠŠYYThreadSafeArrayä¸­çš„é”ç±»å‹æ”¹æˆNSRecursiveLockçš„è¯ï¼Œå°±ä¸ä¼šé€ æˆæ­»é”ã€‚ï¼ˆä¸ºä»€ä¹ˆä½œè€…æ²¡æœ‰æ”¹å‘¢ï¼Ÿæˆ‘æ„Ÿè§‰è¿˜æ˜¯å› ä¸º NSRecursiveLockæ‰§è¡Œæ•ˆç‡ä½ï¼Œä¸å¦‚ dispatch_semaphore_tï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test_YYThreadSafeArray &#123;    </span><br><span class="line">    YYThreadSafeArray *arr = [[YYThreadSafeArray alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        [arr addObject:@(i)];</span><br><span class="line">    &#125;</span><br><span class="line">    [arr enumerateObjectsUsingBlock:^(<span class="keyword">id</span>  _Nonnull obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> * _Nonnull stop) &#123;</span><br><span class="line">        [arr count];</span><br><span class="line">        <span class="keyword">if</span> (idx == arr.count - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@" index:%ld , count:%ld"</span>,idx,arr.count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"finished"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="synchronized"><a href="#synchronized" class="headerlink" title="@synchronized"></a>@synchronized</h3><p>è¿™å…¶å®æ˜¯ä¸€ä¸ª OC å±‚é¢çš„é”ï¼Œ ä¸»è¦æ˜¯é€šè¿‡ç‰ºç‰²æ€§èƒ½æ¢æ¥è¯­æ³•ä¸Šçš„ç®€æ´ä¸å¯è¯»ã€‚æˆ‘ä»¬çŸ¥é“ @synchronized åé¢éœ€è¦ç´§è·Ÿä¸€ä¸ª OC å¯¹è±¡ï¼Œå®ƒå®é™…ä¸Šæ˜¯æŠŠè¿™ä¸ªå¯¹è±¡å½“åšé”æ¥ä½¿ç”¨ã€‚è¿™æ˜¯é€šè¿‡ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥å®ç°çš„ï¼ŒOC åœ¨åº•å±‚ä½¿ç”¨äº†ä¸€ä¸ªäº’æ–¥é”çš„æ•°ç»„(ä½ å¯ä»¥ç†è§£ä¸ºé”æ± )ï¼Œé€šè¿‡å¯¹å¯¹è±¡å»å“ˆå¸Œå€¼æ¥å¾—åˆ°å¯¹åº”çš„äº’æ–¥é”ã€‚</p>
<p>å‚è€ƒï¼š<br><a href="http://www.parallellabs.com/2010/01/31/pthreads-programming-spin-lock-vs-mutex-performance-analysis/" target="_blank" rel="noopener">â¤ï¸Pthreadså¹¶è¡Œç¼–ç¨‹ä¹‹spin lockä¸mutexæ€§èƒ½å¯¹æ¯”åˆ†æâ¤ï¸</a><br><a href="https://bestswifter.com/ios-lock/#nsrecursivelock" target="_blank" rel="noopener">æ·±å…¥ç†è§£ iOS å¼€å‘ä¸­çš„é”</a><br><a href="https://casatwy.com/pthreadde-ge-chong-tong-bu-ji-zhi.html" target="_blank" rel="noopener">pthreadçš„å„ç§åŒæ­¥æœºåˆ¶</a><br><a href="http://blog.csdn.net/yeyuangen/article/details/37593533" target="_blank" rel="noopener">æ·±å…¥ç†è§£æ¡ä»¶å˜é‡</a><br><a href="http://docs.oracle.com/cd/E19253-01/819-7051/6n919hpag/index.html" target="_blank" rel="noopener">oracleå¤šçº¿ç¨‹ç¼–ç¨‹æŒ‡å—</a><br><a href="http://www.cnblogs.com/snailHL/p/3906112.html" target="_blank" rel="noopener">å…³äºdispatch_semaphoreçš„ä½¿ç”¨</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/08/20170508èŠä¸€èŠYYCache/" rel="next" title="èŠä¸€èŠYYCache">
                <i class="fa fa-chevron-left"></i> èŠä¸€èŠYYCache
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/12/20170712çº¿ç¨‹å®‰å…¨ä¹‹gcd/" rel="prev" title="çº¿ç¨‹å®‰å…¨ä¹‹gcd">
                çº¿ç¨‹å®‰å…¨ä¹‹gcd <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTMzNy81OTA1"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wangdetong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#pthread-mutex-t-äº’æ–¥é”-ï¼ˆæœ€å¸¸ç”¨ï¼‰"><span class="nav-number">1.</span> <span class="nav-text">pthread_mutex_t(äº’æ–¥é”)ï¼ˆæœ€å¸¸ç”¨ï¼‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pthread-spinlock-t-è‡ªæ—‹é”"><span class="nav-number">2.</span> <span class="nav-text">pthread_spinlock_t(è‡ªæ—‹é”)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#â¤ï¸spin-lock-ğŸ†š-mutexâ¤ï¸"><span class="nav-number">3.</span> <span class="nav-text">â¤ï¸spin lock ğŸ†š mutexâ¤ï¸</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#é¢„å¤‡çŸ¥è¯†"><span class="nav-number">3.1.</span> <span class="nav-text">é¢„å¤‡çŸ¥è¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#busy-waiting-amp-sleeping"><span class="nav-number">3.2.</span> <span class="nav-text">busy-waiting &amp; sleeping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸¾ä¸ªä¾‹å­"><span class="nav-number">3.3.</span> <span class="nav-text">ä¸¾ä¸ªä¾‹å­</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">3.4.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dispatch-semaphore-t-ä¿¡å·é‡"><span class="nav-number">4.</span> <span class="nav-text">dispatch_semaphore_t(ä¿¡å·é‡)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç›¸å…³å‡½æ•°"><span class="nav-number">4.1.</span> <span class="nav-text">ç›¸å…³å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…³äºä¿¡å·é‡ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœè½¦æ¥æ¯”å–»"><span class="nav-number">4.2.</span> <span class="nav-text">å…³äºä¿¡å·é‡ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœè½¦æ¥æ¯”å–»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#semaphore-ä¾‹å­-é˜»ç¢å½“å‰çº¿ç¨‹"><span class="nav-number">5.</span> <span class="nav-text">semaphore ä¾‹å­(é˜»ç¢å½“å‰çº¿ç¨‹)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å…³äºdispatch-semaphoreçš„ä½¿ç”¨"><span class="nav-number">5.1.</span> <span class="nav-text">å…³äºdispatch_semaphoreçš„ä½¿ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#signal-amp-wait-æˆå¯¹å‡ºç°"><span class="nav-number">5.2.</span> <span class="nav-text">signal &amp; wait æˆå¯¹å‡ºç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pthread-cond-t-æ¡ä»¶å˜é‡"><span class="nav-number">6.</span> <span class="nav-text">pthread_cond_t(æ¡ä»¶å˜é‡)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…demo"><span class="nav-number">6.1.</span> <span class="nav-text">ç”Ÿäº§è€…æ¶ˆè´¹è€…demo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸ºä»€ä¹ˆéœ€è¦é…åˆpthread-mutex-lockï¼Ÿ"><span class="nav-number">6.1.1.</span> <span class="nav-text">ä¸ºä»€ä¹ˆéœ€è¦é…åˆpthread_mutex_lockï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸ºä»€ä¹ˆéœ€è¦-while-è€Œä¸æ˜¯-if-ï¼Ÿ"><span class="nav-number">6.1.2.</span> <span class="nav-text">ä¸ºä»€ä¹ˆéœ€è¦ while è€Œä¸æ˜¯ if ï¼Ÿ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Objective-Cä¸­çš„é”"><span class="nav-number">7.</span> <span class="nav-text">Objective-Cä¸­çš„é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSCondition"><span class="nav-number">7.1.</span> <span class="nav-text">NSCondition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSConditionLock"><span class="nav-number">7.2.</span> <span class="nav-text">NSConditionLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSLock"><span class="nav-number">7.3.</span> <span class="nav-text">NSLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSRecursiveLock"><span class="nav-number">7.4.</span> <span class="nav-text">NSRecursiveLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronized"><span class="nav-number">7.5.</span> <span class="nav-text">@synchronized</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangdetong</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

</body>
</html>
