<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-cn">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="å¤šçº¿ç¨‹çš„æ•°æ®å®‰å…¨é™¤äº†é”èƒ½è§£å†³ï¼Œè¿˜å¯ä»¥é€šè¿‡gcdçš„ä¸€äº›æ–¹æ³•æ¥è§£å†³ï¼šæ¯”å¦‚ å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—ã€ä¿¡å·é‡ã€dispatch_barrier_asyncã€dispatch_group_tâ€¦ç°åœ¨å¯ä»¥é€šè¿‡æºç +ä¾‹å­ æ¥äº†è§£ä¸€ä¸‹å®ƒä»¬ã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå­¦ä¹ gcdçš„ä¸€ä¸ªå¥½çš„æ–¹æ³•å°±æ˜¯çœ‹ä¸€ä¸‹ TMCacheçš„æºç ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="çº¿ç¨‹å®‰å…¨ä¹‹gcd">
<meta property="og:url" content="http://yoursite.com/2017/07/12/20170712çº¿ç¨‹å®‰å…¨ä¹‹gcd/index.html">
<meta property="og:site_name" content="iKiwi">
<meta property="og:description" content="å¤šçº¿ç¨‹çš„æ•°æ®å®‰å…¨é™¤äº†é”èƒ½è§£å†³ï¼Œè¿˜å¯ä»¥é€šè¿‡gcdçš„ä¸€äº›æ–¹æ³•æ¥è§£å†³ï¼šæ¯”å¦‚ å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—ã€ä¿¡å·é‡ã€dispatch_barrier_asyncã€dispatch_group_tâ€¦ç°åœ¨å¯ä»¥é€šè¿‡æºç +ä¾‹å­ æ¥äº†è§£ä¸€ä¸‹å®ƒä»¬ã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå­¦ä¹ gcdçš„ä¸€ä¸ªå¥½çš„æ–¹æ³•å°±æ˜¯çœ‹ä¸€ä¸‹ TMCacheçš„æºç ã€‚">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2019-06-22T03:32:12.590Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="çº¿ç¨‹å®‰å…¨ä¹‹gcd">
<meta name="twitter:description" content="å¤šçº¿ç¨‹çš„æ•°æ®å®‰å…¨é™¤äº†é”èƒ½è§£å†³ï¼Œè¿˜å¯ä»¥é€šè¿‡gcdçš„ä¸€äº›æ–¹æ³•æ¥è§£å†³ï¼šæ¯”å¦‚ å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—ã€ä¿¡å·é‡ã€dispatch_barrier_asyncã€dispatch_group_tâ€¦ç°åœ¨å¯ä»¥é€šè¿‡æºç +ä¾‹å­ æ¥äº†è§£ä¸€ä¸‹å®ƒä»¬ã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå­¦ä¹ gcdçš„ä¸€ä¸ªå¥½çš„æ–¹æ³•å°±æ˜¯çœ‹ä¸€ä¸‹ TMCacheçš„æºç ã€‚">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/12/20170712çº¿ç¨‹å®‰å…¨ä¹‹gcd/">





  <title>çº¿ç¨‹å®‰å…¨ä¹‹gcd | iKiwi</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">iKiwi</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/12/20170712çº¿ç¨‹å®‰å…¨ä¹‹gcd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangdetong">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="iKiwi">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">çº¿ç¨‹å®‰å…¨ä¹‹gcd</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-12T00:00:00+08:00">
                2017-07-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>å¤šçº¿ç¨‹çš„æ•°æ®å®‰å…¨é™¤äº†é”èƒ½è§£å†³ï¼Œè¿˜å¯ä»¥é€šè¿‡gcdçš„ä¸€äº›æ–¹æ³•æ¥è§£å†³ï¼šæ¯”å¦‚ å¼‚æ­¥ä¸²è¡Œé˜Ÿåˆ—ã€ä¿¡å·é‡ã€dispatch_barrier_asyncã€dispatch_group_tâ€¦ç°åœ¨å¯ä»¥é€šè¿‡æºç +ä¾‹å­ æ¥äº†è§£ä¸€ä¸‹å®ƒä»¬ã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå­¦ä¹ gcdçš„ä¸€ä¸ªå¥½çš„æ–¹æ³•å°±æ˜¯çœ‹ä¸€ä¸‹ TMCacheçš„æºç ã€‚</p>
<a id="more"></a>

<h2 id="dispatch-async"><a href="#dispatch-async" class="headerlink" title="dispatch_async"></a><code>dispatch_async</code></h2><p>å¯¹äºdispatch_asyncï¼Œæˆ‘ä»¬çœŸæ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œå…·ä½“ç”¨æ³•å°±ä¸è¯´äº†ï¼Œä¸‹é¢çœ‹ä¸‹éƒ¨åˆ†æºç å§ã€‚<br>é€šè¿‡æºç å‘ç°ï¼š</p>
<ol>
<li>é€šè¿‡<code>dispatch_continuation_t</code> ç®¡ç† groupã€ queue ã€block</li>
<li><code>dispatch_async</code>çš„æ ‡è®°ä½æ˜¯ï¼š<code>DISPATCH_OBJ_CONSUME_BIT</code>ï¼Œæ³¨æ„åœ¨ <code>dispatch_barrier_async</code> æ—¶ï¼Œæ ‡è®°ä½ï¼š <code>DISPATCH_OBJ_CONSUME_BIT | DISPATCH_OBJ_BARRIER_BIT</code>ã€‚</li>
<li>åœ¨å‡½æ•°<code>_dispatch_continuation_async -&gt; _dispatch_continuation_async2</code> ä¸­ï¼Œåˆ¤æ–­flagæ˜¯ä¸æ˜¯ barrier ï¼ˆé€šè¿‡æ ‡è®°ä½ &amp; <code>DISPATCH_OBJ_BARRIER_BIT</code> ï¼‰ï¼Ÿ<br> æ˜¯ï¼šå°±ç›´æ¥è°ƒç”¨<code>_dispatch_continuation_push</code>(ç±»ä¼¼æŠŠblockæ”¾åœ¨queueé‡Œ)ï¼Œ<br> ä¸æ˜¯ï¼šå°±è°ƒç”¨<code>_dispatch_async_f2</code>ï¼ˆç±»ä¼¼å¼‚æ­¥æ‰§è¡Œï¼‰</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="built_in">dispatch_async</span>(<span class="built_in">dispatch_queue_t</span> dq, dispatch_block_t work)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_continuation_t dc = _dispatch_continuation_alloc();</span><br><span class="line">	uintptr_t dc_flags = DISPATCH_OBJ_CONSUME_BIT;</span><br><span class="line">	_dispatch_continuation_init(dc, dq, work, <span class="number">0</span>, <span class="number">0</span>, dc_flags);</span><br><span class="line">	_dispatch_continuation_async(dq, dc);</span><br><span class="line">&#125;</span><br><span class="line">_dispatch_continuation_init(dispatch_continuation_t dc,</span><br><span class="line">		dispatch_queue_class_t dqu, dispatch_block_t work,</span><br><span class="line">		pthread_priority_t pp, dispatch_block_flags_t flags, uintptr_t dc_flags)</span><br><span class="line">&#123;</span><br><span class="line">	dc-&gt;dc_flags = dc_flags | DISPATCH_OBJ_BLOCK_BIT;</span><br><span class="line">	dc-&gt;dc_ctxt = _dispatch_Block_copy(work);</span><br><span class="line">	<span class="comment">// çœç•¥â€¦</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> _dispatch_continuation_async(<span class="built_in">dispatch_queue_t</span> dq, dispatch_continuation_t dc)</span><br><span class="line">&#123;</span><br><span class="line">	_dispatch_continuation_async2(dq, dc,</span><br><span class="line">			dc-&gt;dc_flags &amp; DISPATCH_OBJ_BARRIER_BIT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> _dispatch_continuation_async2(<span class="built_in">dispatch_queue_t</span> dq, dispatch_continuation_t dc,</span><br><span class="line">		<span class="keyword">bool</span> barrier)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (fastpath(barrier || !DISPATCH_QUEUE_USES_REDIRECTION(dq-&gt;dq_width))) &#123;</span><br><span class="line">		<span class="keyword">return</span> _dispatch_continuation_push(dq, dc);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_async_f2(dq, dc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dispatch-semaphore-t"><a href="#dispatch-semaphore-t" class="headerlink" title="dispatch_semaphore_t"></a><code>dispatch_semaphore_t</code></h2><p>åœ¨ä¹‹å‰çš„ã€Šçº¿ç¨‹å®‰å…¨ä¹‹é”ã€‹ä¸­è°ˆåˆ°è¿‡ semaphoreï¼ŒæŠŠsemaphoreçš„valueå€¼è®¾ç½®ä¸º0 å¯ä»¥å½“åš mutex æ¥ä½¿ç”¨ï¼Œå…¶å® semaphore çœŸæ­£å±äºçš„gcdé‡Œé¢çš„ã€‚è¿™é‡Œå°±çœ‹çœ‹semaphoreå®ç°çš„æºç ã€‚</p>
<h3 id="dispatch-semaphore-create"><a href="#dispatch-semaphore-create" class="headerlink" title="dispatch_semaphore_create"></a><code>dispatch_semaphore_create</code></h3><p>å¾ˆç®€å•çš„é€»è¾‘</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dispatch_semaphore_t dispatch_semaphore_create(<span class="keyword">long</span> value)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_semaphore_t dsema;</span><br><span class="line">	<span class="keyword">if</span> (value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> DISPATCH_BAD_INPUT;</span><br><span class="line">	&#125;</span><br><span class="line">	dsema = (dispatch_semaphore_t)_dispatch_alloc(DISPATCH_VTABLE(semaphore),</span><br><span class="line">			<span class="keyword">sizeof</span>(<span class="keyword">struct</span> dispatch_semaphore_s));</span><br><span class="line">	_dispatch_semaphore_class_init(value, dsema);</span><br><span class="line">	dsema-&gt;dsema_orig = value;</span><br><span class="line">	<span class="keyword">return</span> dsema;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatch-semaphore-wait"><a href="#dispatch-semaphore-wait" class="headerlink" title="dispatch_semaphore_wait"></a><code>dispatch_semaphore_wait</code></h3><blockquote>
<p>Decrement the counting semaphore. If the resulting value is less than zero, this function waits for a signal to occur before returning.</p>
</blockquote>
<ul>
<li>ä¿¡å·é‡çš„value -1</li>
<li>æœ€ç»ˆä¼šè°ƒç”¨ å†…æ ¸çš„dispatch_sema4_waitå‡½æ•°ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å‡ºç°ä¸€ä¸ªsignal</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_dec2o(dsema, dsema_value, acquire);</span><br><span class="line">	<span class="keyword">if</span> (fastpath(value &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_wait_slow(dsema, timeout);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">long</span> _dispatch_semaphore_wait_slow(dispatch_semaphore_t dsema,</span><br><span class="line">		dispatch_time_t timeout)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> orig;</span><br><span class="line">	_dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">	<span class="keyword">switch</span> (timeout) &#123;</span><br><span class="line">	<span class="comment">// çœç•¥...</span></span><br><span class="line">	<span class="keyword">case</span> DISPATCH_TIME_FOREVER:</span><br><span class="line">		_dispatch_sema4_wait(&amp;dsema-&gt;dsema_sema);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatch-semaphore-signal"><a href="#dispatch-semaphore-signal" class="headerlink" title="dispatch_semaphore_signal"></a>dispatch_semaphore_signal</h3><blockquote>
<p>If the previous value was less than zero, this function wakes a process currently waiting.</p>
</blockquote>
<ul>
<li>è®©ä¿¡å·é‡çš„value +1</li>
<li>æœ€ç»ˆä¼šè°ƒç”¨ è°ƒç”¨å†…æ ¸çš„ _dispatch_sema4_signal å‡½æ•°å”¤é†’çº¿ç¨‹ï¼Œç„¶åè¿”å› 1ã€‚</li>
<li>ä¹Ÿç¬¦åˆæ–‡æ¡£ä¸­çš„æè¿°:â€œå¦‚æœå”¤é†’äº†çº¿ç¨‹ï¼Œè¿”å›é 0ï¼Œå¦åˆ™è¿”å› 0â€ã€‚</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> _dispatch_semaphore_signal_slow(dispatch_semaphore_t dsema)</span><br><span class="line">&#123;</span><br><span class="line">	_dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">	_dispatch_sema4_signal(&amp;dsema-&gt;dsema_sema, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">long</span> dispatch_semaphore_signal(dispatch_semaphore_t dsema)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_inc2o(dsema, dsema_value, release);</span><br><span class="line">	<span class="keyword">if</span> (fastpath(value &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (slowpath(value == LONG_MIN)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">"Unbalanced call to dispatch_semaphore_signal()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_signal_slow(dsema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="TMCacheä¸­çš„ç®€å•ç”¨æ³•"><a href="#TMCacheä¸­çš„ç®€å•ç”¨æ³•" class="headerlink" title="TMCacheä¸­çš„ç®€å•ç”¨æ³•"></a>TMCacheä¸­çš„ç®€å•ç”¨æ³•</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)objectForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    __block <span class="keyword">id</span> objectForKey = <span class="literal">nil</span>;</span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    [<span class="keyword">self</span> objectForKey:key block:^(TMCache *cache, <span class="built_in">NSString</span> *key, <span class="keyword">id</span> object) &#123;</span><br><span class="line">        objectForKey = object;</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;];</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="meta">#if !OS_OBJECT_USE_OBJC</span></span><br><span class="line">    dispatch_release(semaphore);</span><br><span class="line">    <span class="meta">#endif</span></span><br><span class="line">    <span class="keyword">return</span> objectForKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dispatch-barrier-a-sync"><a href="#dispatch-barrier-a-sync" class="headerlink" title="dispatch_barrier (a)sync"></a><code>dispatch_barrier (a)sync</code></h2><p>çœ‹è¿‡ TMCacheæºç å‘ç°ï¼Œå…¶ä¸­å¤§é‡ä½¿ç”¨äº† dispatch_barrier_asyncï¼Œè¿™é‡Œå°±é€šè¿‡ æºç +ä¾‹å­ çš„å½¢å¼äº†è§£ä¸€ä¸‹ dispatch_barrierã€‚</p>
<p>ä½œç”¨ï¼šç­‰å‰é¢çš„æ‰§è¡Œå®Œäº† -&gt; å†æ‰§è¡Œbrrier -&gt; åé¢çš„ä»»åŠ¡ã€‚</p>
<h3 id="dispatch-barrier-a-sync-åŸºæœ¬åŠŸèƒ½-amp-ç”¨æ³•"><a href="#dispatch-barrier-a-sync-åŸºæœ¬åŠŸèƒ½-amp-ç”¨æ³•" class="headerlink" title="dispatch_barrier (a)sync åŸºæœ¬åŠŸèƒ½&amp;ç”¨æ³•"></a>dispatch_barrier (a)sync åŸºæœ¬åŠŸèƒ½&amp;ç”¨æ³•</h3><p>é’ˆå¯¹å¹¶å‘é˜Ÿåˆ—ï¼Œä½†æ˜¯å…¨å±€é˜Ÿåˆ—é™¤å¤–ï¼Œå¦‚æœä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—æˆ–å…¨å±€é˜Ÿåˆ—ï¼Œdispatch_barrier_asyncå°±å’Œdispatch_async å‡½æ•°æ•ˆæœäº†ã€‚<br>dispatch_barrier_(a)sync ä¸ dispatch_(a)syncæ˜¯ä¸€ä¸ªé“ç†çš„ï¼Œsyncé˜»ç¢å½“å‰çº¿ç¨‹ï¼Œè€Œasyncä¸é˜»ç¢ã€‚<br>syncä¼šé˜»ç¢å½“å‰çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œè‡ªå·±çš„blockä»»åŠ¡åæ‰§è¡Œä¸‹é¢çš„ç¨‹åºï¼Œè€Œasyncä¸é˜»ç¢å½“å‰çº¿ç¨‹ï¼Œåªè´Ÿè´£æŠŠblockä»»åŠ¡æ”¾åˆ°queueé‡Œå°±è¡Œäº†ã€‚<br>sync &amp; asyncéƒ½ä¼šè®©barrierç”Ÿæ•ˆï¼Œé˜»ç¢queue é‡Œçš„ä»»åŠ¡</p>
<h4 id="async-barrier-demo"><a href="#async-barrier-demo" class="headerlink" title="async barrier demo"></a>async barrier demo</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) testBarrierBlock &#123;   </span><br><span class="line"><span class="built_in">dispatch_queue_t</span> myConcurrentQueue = dispatch_queue_create(<span class="string">"myConcurrentQueue"</span>,DISPATCH_QUEUE_CONCURRENT);<span class="comment">// éœ€è¦è‡ªå·±åˆ›å»º</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;<span class="comment">// 1ã€2æ˜¯å¹¶è¡Œçš„</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 1"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 2"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line">dispatch_barrier_async(myConcurrentQueue, ^&#123;<span class="comment">// ç­‰1.2éƒ½æ‰§è¡Œå®Œä¾¿ä¼šæ‰§è¡Œæ­¤æ–¹æ³•ï¼Œæ­¤æ—¶ä¾¿ä¼šå°†çº¿ç¨‹å»¶è¿Ÿç›´è‡³barrieræ‰§è¡Œå®Œæ¯•æ–¹å¯</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch barrier"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;<span class="comment">// 3ã€4æ˜¯å¹¶è¡Œçš„</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 3"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 4"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sync-barrier-demo"><a href="#sync-barrier-demo" class="headerlink" title="sync barrier demo"></a>sync barrier demo</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> myConcurrentQueue = dispatch_queue_create(<span class="string">"myConcurrentQueue"</span>, DISPATCH_QUEUE_CONCURRENT);<span class="comment">// éœ€è¦è‡ªå·±åˆ›å»º</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;<span class="comment">// 1.2æ˜¯å¹¶è¡Œçš„       </span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 1"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 2"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line">dispatch_barrier_sync(myConcurrentQueue, ^&#123;<span class="comment">// æŠŠsyncæ”¹ä¸ºasyncæŸ¥çœ‹æ‰“å°å¯¹æ¯”</span></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch barrier"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 3"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(myConcurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"dispatch test 4"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"just for test sync &amp; async"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"just for test sync &amp; async"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"just for test sync &amp; async"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"just for test sync &amp; async"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"just for test sync &amp; async"</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"just for test sync &amp; async"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="barrierå®ç°-nameçº¿ç¨‹å®‰å…¨"><a href="#barrierå®ç°-nameçº¿ç¨‹å®‰å…¨" class="headerlink" title="barrierå®ç° nameçº¿ç¨‹å®‰å…¨"></a>barrierå®ç° nameçº¿ç¨‹å®‰å…¨</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    dispatch_barrier_async(_concurrentQueue, ^&#123;</span><br><span class="line">        _name = [name <span class="keyword">copy</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    __block <span class="built_in">NSString</span> *tempName;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(_concurrentQueue, ^&#123;</span><br><span class="line">        tempName = _name;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> tempName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TMCacheä¸­å¯¹-dispatch-barrier-async-çš„ä½¿ç”¨"><a href="#TMCacheä¸­å¯¹-dispatch-barrier-async-çš„ä½¿ç”¨" class="headerlink" title="TMCacheä¸­å¯¹ dispatch_barrier_async çš„ä½¿ç”¨"></a>TMCacheä¸­å¯¹ dispatch_barrier_async çš„ä½¿ç”¨</h4><p>TMMemoryCache åœ¨è®¾è®¡æ—¶ï¼Œä¸»è¦ç›®æ ‡æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå®ƒæŠŠæ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ”¾åˆ°äº†åŒä¸€ä¸ª concurrent queue ä¸­ï¼Œç„¶åç”¨ dispatch_barrier_async æ¥ä¿è¯ä»»åŠ¡èƒ½é¡ºåºæ‰§è¡Œ<br>ä¸¾ä¸ªğŸŒ°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key block:(TMMemoryCacheObjectBlock)block</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    __<span class="keyword">weak</span> TMMemoryCache *weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    dispatch_barrier_async(_queue, ^&#123;</span><br><span class="line">        TMMemoryCache *strongSelf = weakSelf;</span><br><span class="line">        <span class="keyword">if</span> (!strongSelf)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        [strongSelf removeObjectAndExecuteBlocksForKey:key];</span><br><span class="line">        <span class="keyword">if</span> (block) &#123;</span><br><span class="line">            __<span class="keyword">weak</span> TMMemoryCache *weakSelf = strongSelf;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(strongSelf-&gt;_queue, ^&#123;</span><br><span class="line">                TMMemoryCache *strongSelf = weakSelf;</span><br><span class="line">                <span class="keyword">if</span> (strongSelf)</span><br><span class="line">                    block(strongSelf, key, <span class="literal">nil</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatch-barrier-async-éƒ¨åˆ†æºç "><a href="#dispatch-barrier-async-éƒ¨åˆ†æºç " class="headerlink" title="dispatch_barrier_async éƒ¨åˆ†æºç "></a>dispatch_barrier_async éƒ¨åˆ†æºç </h3><ol>
<li>å¯¹æ¯”æºç  dispatch_barrier_async &amp; dispatch_async å‘ç°:<br>å‰è€…çš„æ ‡è®°ä½ä¸ºDISPATCH_OBJ_CONSUME_BIT | DISPATCH_OBJ_BARRIER_BITï¼Œåè€…ä¸ºDISPATCH_OBJ_CONSUME_BIT<br>å‰è€…ç›´æ¥è°ƒç”¨äº† _dispatch_continuation_pushï¼Œåè€…è°ƒç”¨äº†_dispatch_continuation_async -&gt; æ»¡è¶³æ¡ä»¶å†è°ƒç”¨_dispatch_continuation_push</li>
<li>ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ—¶ä¼šç”¨åˆ°æ ‡è®°ä½ï¼š<br>å¾ªç¯æ‹¿å‡ºæ‰€æœ‰çš„ä»»åŠ¡ï¼Œä¾æ¬¡è°ƒç”¨ _dispatch_continuation_redirectæœ€ç»ˆå¹¶è¡Œå¤„ç†ã€‚ä¸€æ—¦é‡åˆ°DISPATCH_OBJ_BARRIER_BITè¿™ä¸ªæ ‡è®°ï¼Œå°±ä¼šç»ˆæ­¢å¾ªç¯ã€‚åœ¨ out æ ‡ç­¾åé¢ï¼Œè¿”å›äº†ä¸€ä¸ªç©ºçš„ä¿¡å·é‡ï¼Œéšåæ–¹æ³•çš„è°ƒç”¨è€…ä¼šæŠŠå®ƒå•ç‹¬æ”¾å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ‰§è¡Œã€‚</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> dispatch_barrier_async(<span class="built_in">dispatch_queue_t</span> dq, dispatch_block_t work)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_continuation_t dc = _dispatch_continuation_alloc();</span><br><span class="line">	uintptr_t dc_flags = DISPATCH_OBJ_CONSUME_BIT | DISPATCH_OBJ_BARRIER_BIT;</span><br><span class="line">	_dispatch_continuation_init(dc, dq, work, <span class="number">0</span>, <span class="number">0</span>, dc_flags);</span><br><span class="line">	_dispatch_continuation_push(dq, dc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dispatch-group-t"><a href="#dispatch-group-t" class="headerlink" title="dispatch_group_t"></a>dispatch_group_t</h2><blockquote>
<p>Grouping blocks allows for aggregate synchronization. Your application can submit multiple blocks and track when they all complete, even though they might run on different queues. This behavior can be helpful when progress canâ€™t be made until all of the specified tasks are complete.</p>
</blockquote>
<p>dispatch_groupæä¾›äº†å¤šä¸ªblockä¹‹é—´çš„åŒæ­¥æœºåˆ¶ï¼Œå¯ä»¥åœ¨å¤šä¸ªblockéƒ½æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œæœ‰ä¾èµ–çš„ä»»åŠ¡(ä¸€èˆ¬ç”¨äºï¼šå½“å¹¶å‘é˜Ÿåˆ—çš„ä¸­æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆå æœ€åå†å»åšæŸç§ä»»åŠ¡ï¼ï¼›è€Œä¸²è¡Œé˜Ÿåˆ—ç›´æ¥æŠŠ é‚£ä¸ªä»»åŠ¡ æ”¾åœ¨é˜Ÿåˆ—çš„æœ€åå°±è¡Œï¼)<br>dispatch_groupå¯ä»¥ç®¡ç†ä¸åŒç±»å‹çš„queueï¼ŒğŸ‘‡ä¸‹é¢ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ç”¨äº†åŒä¸€ä¸ªqueue</p>
<h3 id="dispatch-group-tåŸºæœ¬åŠŸèƒ½-amp-ç”¨æ³•"><a href="#dispatch-group-tåŸºæœ¬åŠŸèƒ½-amp-ç”¨æ³•" class="headerlink" title="dispatch_group_tåŸºæœ¬åŠŸèƒ½&amp;ç”¨æ³•"></a>dispatch_group_tåŸºæœ¬åŠŸèƒ½&amp;ç”¨æ³•</h3><h4 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="headerlink" title="ç›¸å…³å‡½æ•°"></a>ç›¸å…³å‡½æ•°</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_t dispatch_group_create(<span class="keyword">void</span>);</span><br><span class="line"><span class="keyword">void</span> dispatch_group_async(dispatch_group_t group,<span class="built_in">dispatch_queue_t</span> queue,dispatch_block_t block);</span><br><span class="line"><span class="comment">// dispatch_group_enterå’Œdispatch_group_leaveéœ€è¦æˆå¯¹å‡ºç°</span></span><br><span class="line"><span class="keyword">void</span> dispatch_group_enter(dispatch_group_t group);</span><br><span class="line"><span class="keyword">void</span> dispatch_group_leave(dispatch_group_t group);</span><br><span class="line"><span class="comment">// ç­‰å¾…ç»„ä»»åŠ¡å®Œæˆï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“ä»»åŠ¡ç»„æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ‰ä¼šè§£é™¤é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">long</span> dispatch_group_wait(dispatch_group_t group, dispatch_time_t timeout);</span><br><span class="line"><span class="comment">// å¾…ä»»åŠ¡ç»„æ‰§è¡Œå®Œæ¯•æ—¶è°ƒç”¨ï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">void</span> dispatch_group_notify(dispatch_group_t group,<span class="built_in">dispatch_queue_t</span> queue, dispatch_block_t block);</span><br></pre></td></tr></table></figure>

<h4 id="groupé‡Œæ²¡æœ‰åµŒå¥—å¼‚æ­¥ä»»åŠ¡"><a href="#groupé‡Œæ²¡æœ‰åµŒå¥—å¼‚æ­¥ä»»åŠ¡" class="headerlink" title="groupé‡Œæ²¡æœ‰åµŒå¥—å¼‚æ­¥ä»»åŠ¡"></a>groupé‡Œæ²¡æœ‰åµŒå¥—å¼‚æ­¥ä»»åŠ¡</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;    </span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@"ä»»åŠ¡ä¸€"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">   </span><br><span class="line"> dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"ä»»åŠ¡äºŒ"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"ä»»åŠ¡äºŒ"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"> dispatch_group_notify(group, concurrentQueue, ^&#123;</span><br><span class="line"> 	<span class="built_in">NSLog</span>(<span class="string">@" done "</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="å½“groupé‡Œå«æœ‰åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦å¼•å…¥leave-ã€enter"><a href="#å½“groupé‡Œå«æœ‰åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦å¼•å…¥leave-ã€enter" class="headerlink" title="å½“groupé‡Œå«æœ‰åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦å¼•å…¥leave ã€enter"></a>å½“groupé‡Œå«æœ‰åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦å¼•å…¥leave ã€enter</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;    </span><br><span class="line">	dispatch_group_enter(group);<span class="comment">// åº•å±‚ï¼šä¿¡å·é‡ +1</span></span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    	sleep(<span class="number">1</span>); <span class="comment">//è¿™é‡Œçº¿ç¨‹ç¡çœ 1ç§’é’Ÿï¼Œæ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚</span></span><br><span class="line">    	<span class="built_in">NSLog</span>(<span class="string">@"æ—¥ç¨‹è¯¦æƒ… ä¸‹è½½æˆåŠŸ"</span>);</span><br><span class="line">    	dispatch_group_leave(group);<span class="comment">// åº•å±‚ï¼šä¿¡å·é‡ -1</span></span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">   </span><br><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;    </span><br><span class="line">	dispatch_group_enter(group);</span><br><span class="line">	<span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    	sleep(<span class="number">1</span>); <span class="comment">//è¿™é‡Œçº¿ç¨‹ç¡çœ 1ç§’é’Ÿï¼Œæ¨¡æ‹Ÿå¼‚æ­¥è¯·æ±‚</span></span><br><span class="line">    	<span class="built_in">NSLog</span>(<span class="string">@"è¯„è®ºå†…å®¹ ä¸‹è½½æˆåŠŸ"</span>);</span><br><span class="line">    	dispatch_group_leave(group);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, concurrentQueue, ^&#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"hahaha"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">	<span class="comment">// éƒ½ä¸‹è½½å®Œæˆå æ›´æ–°UIï¼</span></span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"notify:load finished"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="TMCache-ä¸­å…³äº-group-çš„ä¾‹å­"><a href="#TMCache-ä¸­å…³äº-group-çš„ä¾‹å­" class="headerlink" title="TMCache ä¸­å…³äº group çš„ä¾‹å­"></a>TMCache ä¸­å…³äº group çš„ä¾‹å­</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span> &lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key block:(TMCacheObjectBlock)block</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key || !object)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    dispatch_group_t group = <span class="literal">nil</span>;</span><br><span class="line">    TMMemoryCacheObjectBlock memBlock = <span class="literal">nil</span>;</span><br><span class="line">    TMDiskCacheObjectBlock diskBlock = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        group = dispatch_group_create();</span><br><span class="line">        dispatch_group_enter(group);</span><br><span class="line">        dispatch_group_enter(group);</span><br><span class="line">        </span><br><span class="line">        memBlock = ^(TMMemoryCache *cache, <span class="built_in">NSString</span> *key, <span class="keyword">id</span> object) &#123;</span><br><span class="line">            dispatch_group_leave(group);</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        diskBlock = ^(TMDiskCache *cache, <span class="built_in">NSString</span> *key, <span class="keyword">id</span> &lt;<span class="built_in">NSCoding</span>&gt; object, <span class="built_in">NSURL</span> *fileURL) &#123;</span><br><span class="line">            dispatch_group_leave(group);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [_memoryCache setObject:object forKey:key block:memBlock];</span><br><span class="line">    [_diskCache setObject:object forKey:key block:diskBlock];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (group) &#123;</span><br><span class="line">        __<span class="keyword">weak</span> TMCache *weakSelf = <span class="keyword">self</span>;</span><br><span class="line">        dispatch_group_notify(group, _queue, ^&#123;</span><br><span class="line">            TMCache *strongSelf = weakSelf;</span><br><span class="line">            <span class="keyword">if</span> (strongSelf)</span><br><span class="line">                block(strongSelf, key, object);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="meta">#if !OS_OBJECT_USE_OBJC</span></span><br><span class="line">        dispatch_release(group);</span><br><span class="line">        <span class="meta">#endif</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="dispatch-group-t-éƒ¨åˆ†æºç "><a href="#dispatch-group-t-éƒ¨åˆ†æºç " class="headerlink" title="dispatch_group_t éƒ¨åˆ†æºç "></a>dispatch_group_t éƒ¨åˆ†æºç </h3><h4 id="dispatch-group-create"><a href="#dispatch-group-create" class="headerlink" title="dispatch_group_create"></a><code>dispatch_group_create</code></h4><ul>
<li>group å°±æ˜¯ ä¿¡å·é‡</li>
<li>groupä½œä¸ºä¿¡å·é‡çš„value ä¸º0ï¼Œå¥½åƒæ—§ç‰ˆæœ¬valueæ˜¯LONG-MAX</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> dispatch_group_t _dispatch_group_create_with_count(<span class="keyword">long</span> count)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_group_t dg = (dispatch_group_t)_dispatch_alloc(</span><br><span class="line">			DISPATCH_VTABLE(group), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dispatch_group_s));</span><br><span class="line">	_dispatch_semaphore_class_init(count, dg);</span><br><span class="line">	<span class="keyword">if</span> (count) &#123;</span><br><span class="line">		os_atomic_store2o(dg, do_ref_cnt, <span class="number">1</span>, relaxed); <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dg;</span><br><span class="line">&#125;</span><br><span class="line">dispatch_group_t dispatch_group_create(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_group_create_with_count(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dispatch_semaphore_class_init(<span class="keyword">long</span> value, dispatch_semaphore_class_t dsemau)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> dispatch_semaphore_header_s *dsema = dsemau._dsema_hdr;</span><br><span class="line">	dsema-&gt;do_next = DISPATCH_OBJECT_LISTLESS;</span><br><span class="line">	dsema-&gt;do_targetq = _dispatch_get_root_queue(DISPATCH_QOS_DEFAULT, <span class="literal">false</span>);</span><br><span class="line">	dsema-&gt;dsema_value = value;</span><br><span class="line">	_dispatch_sema4_init(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dispatch-group-enter"><a href="#dispatch-group-enter" class="headerlink" title="dispatch_group_enter"></a>dispatch_group_enter</h4><p>å…¶å†…éƒ¨è°ƒç”¨å®å®šä¹‰æ–¹æ³•os_atomic_inc_orig2oï¼Œä¹Ÿå°±æ˜¯è®© ä¿¡å·é‡çš„value increment 1</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> dispatch_group_enter(dispatch_group_t dg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_inc_orig2o(dg, dg_value, acquire);</span><br><span class="line">	<span class="keyword">if</span> (slowpath((<span class="keyword">unsigned</span> <span class="keyword">long</span>)value &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)LONG_MAX)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">"Too many nested calls to dispatch_group_enter()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (value == <span class="number">0</span>) &#123;</span><br><span class="line">		_dispatch_retain(dg); <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#define os_atomic_inc_orig2o(p, f, m) \</span></span><br><span class="line">		os_atomic_add_orig2o(p, f, <span class="number">1</span>, m)</span><br></pre></td></tr></table></figure>

<h4 id="dispatch-group-leave"><a href="#dispatch-group-leave" class="headerlink" title="dispatch_group_leave"></a>dispatch_group_leave</h4><p>å…¶å†…éƒ¨è°ƒç”¨å®å®šä¹‰æ–¹æ³•os_atomic_dec2oï¼Œä¹Ÿå°±æ˜¯è®© ä¿¡å·é‡çš„value decrement 1<br>å¦‚æœä¿¡å·é‡çš„value == 0ï¼Œå°±æ˜¯ä¸åˆå§‹å€¼ä¸€è‡´ï¼Œå°±å”¤é†’group</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> dispatch_group_leave(dispatch_group_t dg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_dec2o(dg, dg_value, release);</span><br><span class="line">	<span class="keyword">if</span> (slowpath(value == <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">void</span>)_dispatch_group_wake(dg, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (slowpath(value &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">"Unbalanced call to dispatch_group_leave()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dispatch-group-async"><a href="#dispatch-group-async" class="headerlink" title="dispatch_group_async"></a>dispatch_group_async</h4><blockquote>
<p>dispatch_group_async -&gt; _dispatch_continuation_group_async -&gt; dispatch_group_enter å…¶ç›®çš„æ˜¯è®© ä¿¡å·é‡çš„value +1ï¼ŒçŒœæµ‹ åœ¨ blockæ‰§è¡Œä¹‹åï¼Œä¿¡å·é‡çš„value -1</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">dispatch_group_async(dispatch_group_t dg, <span class="built_in">dispatch_queue_t</span> dq, dispatch_block_t db)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_continuation_t dc = _dispatch_continuation_alloc();</span><br><span class="line">	uintptr_t dc_flags = DISPATCH_OBJ_CONSUME_BIT | DISPATCH_OBJ_GROUP_BIT;</span><br><span class="line">	_dispatch_continuation_init(dc, dq, db, <span class="number">0</span>, <span class="number">0</span>, dc_flags);</span><br><span class="line">	_dispatch_continuation_group_async(dg, dq, dc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> _dispatch_continuation_group_async(dispatch_group_t dg, <span class="built_in">dispatch_queue_t</span> dq,</span><br><span class="line">		dispatch_continuation_t dc)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_group_enter(dg);</span><br><span class="line">	dc-&gt;dc_data = dg;</span><br><span class="line">	_dispatch_continuation_async(dq, dc); <span class="comment">//...TODO...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dispatch-group-notify"><a href="#dispatch-group-notify" class="headerlink" title="dispatch_group_notify"></a>dispatch_group_notify</h4><p>dsn-&gt;do_next = NULLï¼šæ ‡è®°blockåœ¨æ‰§è¡Œé“¾è¡¨çš„å°¾éƒ¨ï¼Œç­‰å¾…groupçš„æ‰€æœ‰blockæ‰§è¡Œå®Œå†æ‰§è¡Œè¿™ä¸ªblock</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> dispatch_group_notify(dispatch_group_t dg, <span class="built_in">dispatch_queue_t</span> dq,</span><br><span class="line">		dispatch_block_t db)</span><br><span class="line">&#123;</span><br><span class="line">	dispatch_continuation_t dsn = _dispatch_continuation_alloc();</span><br><span class="line">	_dispatch_continuation_init(dsn, dq, db, <span class="number">0</span>, <span class="number">0</span>, DISPATCH_OBJ_CONSUME_BIT);</span><br><span class="line">	_dispatch_group_notify(dg, dq, dsn);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> _dispatch_group_notify(dispatch_group_t dg, <span class="built_in">dispatch_queue_t</span> dq,</span><br><span class="line">		dispatch_continuation_t dsn)</span><br><span class="line">&#123;</span><br><span class="line">	dsn-&gt;dc_data = dq;</span><br><span class="line">	dsn-&gt;do_next = <span class="literal">NULL</span>;</span><br><span class="line">	_dispatch_retain(dq);</span><br><span class="line">	<span class="comment">// çœç•¥â€¦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dispatch-group-wait"><a href="#dispatch-group-wait" class="headerlink" title="dispatch_group_wait"></a>dispatch_group_wait</h4><p>group_waitçš„ä¸­æœ‰ <code>_dispatch_sema4_create &amp; _dispatch_sema4_wait</code> å¯ä»¥ç®€å•çš„ç†è§£ä¸º ç”¨ä¿¡å·é‡ è¿›è¡Œç­‰å¾…ï¼Œé˜»ç¢å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…groupä¸­çš„æ‰€æœ‰äº‹ä»¶å®Œæˆã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> dispatch_group_wait(dispatch_group_t dg, dispatch_time_t timeout)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (dg-&gt;dg_value == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (timeout == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> _DSEMA4_TIMEOUT();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_group_wait_slow(dg, timeout);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">long</span> _dispatch_group_wait_slow(dispatch_group_t dg, dispatch_time_t timeout)</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	_dispatch_sema4_create(&amp;dg-&gt;dg_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">	<span class="keyword">switch</span> (timeout) &#123;</span><br><span class="line">	<span class="comment">// çœç•¥â€¦</span></span><br><span class="line">	<span class="keyword">case</span> DISPATCH_TIME_FOREVER:</span><br><span class="line">		_dispatch_sema4_wait(&amp;dg-&gt;dg_sema);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒï¼š<br><a href="https://bestswifter.com/deep-gcd/" target="_blank" rel="noopener">æ·±å…¥ç†è§£GCD</a><br><a href="https://github.com/tumblr/TMCache" target="_blank" rel="noopener">TMCache</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/11/20170611çº¿ç¨‹å®‰å…¨ä¹‹é”/" rel="next" title="çº¿ç¨‹å®‰å…¨ä¹‹é”">
                <i class="fa fa-chevron-left"></i> çº¿ç¨‹å®‰å…¨ä¹‹é”
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/08/25/20170825appç˜¦èº«ä¹‹ç§»é™¤æ— ç”¨machoæ–‡ä»¶/" rel="prev" title="appç˜¦èº«ä¹‹ç§»é™¤æ— ç”¨machoæ–‡ä»¶">
                appç˜¦èº«ä¹‹ç§»é™¤æ— ç”¨machoæ–‡ä»¶ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTMzNy81OTA1"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wangdetong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#dispatch-async"><span class="nav-number">1.</span> <span class="nav-text">dispatch_async</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dispatch-semaphore-t"><span class="nav-number">2.</span> <span class="nav-text">dispatch_semaphore_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-semaphore-create"><span class="nav-number">2.1.</span> <span class="nav-text">dispatch_semaphore_create</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-semaphore-wait"><span class="nav-number">2.2.</span> <span class="nav-text">dispatch_semaphore_wait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-semaphore-signal"><span class="nav-number">2.3.</span> <span class="nav-text">dispatch_semaphore_signal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TMCacheä¸­çš„ç®€å•ç”¨æ³•"><span class="nav-number">2.4.</span> <span class="nav-text">TMCacheä¸­çš„ç®€å•ç”¨æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dispatch-barrier-a-sync"><span class="nav-number">3.</span> <span class="nav-text">dispatch_barrier (a)sync</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-barrier-a-sync-åŸºæœ¬åŠŸèƒ½-amp-ç”¨æ³•"><span class="nav-number">3.1.</span> <span class="nav-text">dispatch_barrier (a)sync åŸºæœ¬åŠŸèƒ½&amp;ç”¨æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#async-barrier-demo"><span class="nav-number">3.1.1.</span> <span class="nav-text">async barrier demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sync-barrier-demo"><span class="nav-number">3.1.2.</span> <span class="nav-text">sync barrier demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#barrierå®ç°-nameçº¿ç¨‹å®‰å…¨"><span class="nav-number">3.1.3.</span> <span class="nav-text">barrierå®ç° nameçº¿ç¨‹å®‰å…¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TMCacheä¸­å¯¹-dispatch-barrier-async-çš„ä½¿ç”¨"><span class="nav-number">3.1.4.</span> <span class="nav-text">TMCacheä¸­å¯¹ dispatch_barrier_async çš„ä½¿ç”¨</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-barrier-async-éƒ¨åˆ†æºç "><span class="nav-number">3.2.</span> <span class="nav-text">dispatch_barrier_async éƒ¨åˆ†æºç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dispatch-group-t"><span class="nav-number">4.</span> <span class="nav-text">dispatch_group_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-group-tåŸºæœ¬åŠŸèƒ½-amp-ç”¨æ³•"><span class="nav-number">4.1.</span> <span class="nav-text">dispatch_group_tåŸºæœ¬åŠŸèƒ½&amp;ç”¨æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ç›¸å…³å‡½æ•°"><span class="nav-number">4.1.1.</span> <span class="nav-text">ç›¸å…³å‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#groupé‡Œæ²¡æœ‰åµŒå¥—å¼‚æ­¥ä»»åŠ¡"><span class="nav-number">4.1.2.</span> <span class="nav-text">groupé‡Œæ²¡æœ‰åµŒå¥—å¼‚æ­¥ä»»åŠ¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å½“groupé‡Œå«æœ‰åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦å¼•å…¥leave-ã€enter"><span class="nav-number">4.1.3.</span> <span class="nav-text">å½“groupé‡Œå«æœ‰åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œéœ€è¦å¼•å…¥leave ã€enter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TMCache-ä¸­å…³äº-group-çš„ä¾‹å­"><span class="nav-number">4.1.4.</span> <span class="nav-text">TMCache ä¸­å…³äº group çš„ä¾‹å­</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-group-t-éƒ¨åˆ†æºç "><span class="nav-number">4.2.</span> <span class="nav-text">dispatch_group_t éƒ¨åˆ†æºç </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-create"><span class="nav-number">4.2.1.</span> <span class="nav-text">dispatch_group_create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-enter"><span class="nav-number">4.2.2.</span> <span class="nav-text">dispatch_group_enter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-leave"><span class="nav-number">4.2.3.</span> <span class="nav-text">dispatch_group_leave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-async"><span class="nav-number">4.2.4.</span> <span class="nav-text">dispatch_group_async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-notify"><span class="nav-number">4.2.5.</span> <span class="nav-text">dispatch_group_notify</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-wait"><span class="nav-number">4.2.6.</span> <span class="nav-text">dispatch_group_wait</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangdetong</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

</body>
</html>
