<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-cn">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="app启动优化属于一个老生常谈的话题，其优化思路早已耳濡目染。">
<meta property="og:type" content="article">
<meta property="og:title" content="app启动优化">
<meta property="og:url" content="http://yoursite.com/2018/12/20/20181220app启动优化/index.html">
<meta property="og:site_name" content="iKiwi">
<meta property="og:description" content="app启动优化属于一个老生常谈的话题，其优化思路早已耳濡目染。">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://yoursite.com/2018/12/20/20181220app启动优化/20181220app%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/a.png">
<meta property="og:updated_time" content="2019-06-22T03:32:12.686Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="app启动优化">
<meta name="twitter:description" content="app启动优化属于一个老生常谈的话题，其优化思路早已耳濡目染。">
<meta name="twitter:image" content="http://yoursite.com/2018/12/20/20181220app启动优化/20181220app%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/a.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/20/20181220app启动优化/">





  <title>app启动优化 | iKiwi</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">iKiwi</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/20/20181220app启动优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wangdetong">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="iKiwi">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">app启动优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-12-20T22:53:42+08:00">
                2018-12-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>app启动优化属于一个老生常谈的话题，其优化思路早已耳濡目染。</p>
<a id="more"></a>

<h2 id="一、分析"><a href="#一、分析" class="headerlink" title="一、分析"></a>一、分析</h2><p>启动过程：<code>点击app --&gt; 执行main() --&gt; 执行didFinishLaunchingWithOptions() --&gt; 构建首页，并渲染完成</code><br>启动时间：从“点击app”至“首页渲染完成”之间的时间段。<br>优化时机：main()之前的系统加载逻辑、didFinishLaunchingWithOptions()中的逻辑、首页构建的过程。<br>优化途径：<code>推迟&amp;减少耗时操作</code></p>
<h2 id="二、优化"><a href="#二、优化" class="headerlink" title="二、优化"></a>二、优化</h2><h3 id="main-之前"><a href="#main-之前" class="headerlink" title="main()之前"></a>main()之前</h3><p>main()调用之前的加载过程：真正的加载过程从exec()函数开始，exec()是一个系统调用。操作系统首先为进程分配一段内存空间，然后执行如下操作：<br><img src="20181220app%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/a.png" alt></p>
<blockquote>
<p>App开始启动后，系统首先加载可执行文件（自身App的所有.o文件的集合），然后加载动态链接库dyld（dyld是一个专门用来加载动态链接库的库）。 dyld从可执行文件的依赖开始, 递归加载所有的依赖动态链接库。</p>
</blockquote>
<p>动态链接库的加载步骤：<br>1、load dylibs image 读取库镜像文件：<br>2、rebase、bind image：修复镜像中的资源指针指向正确的地址</p>
<blockquote>
<p>由于<code>ASLR(address space layout randomization)</code>的存在，可执行文件和动态链接库在虚拟内存中的加载地址每次启动都不固定，所以需要rebase &amp; bind来修复镜像中的资源指针，来指向正确的地址。<br>rebase ：dylib 内部的指针地址都加上这个偏移量<br>bind：是处理那些指向 dylib 外部的指针</p>
</blockquote>
<p>3、class setup：注册class、把category的定义插入方法列表<br>4、initializers：执行+load()</p>
<p>了解流程后可知，rebase、bind image 和 Objc setup属于静态调整(fix-up)，都是在修改__DATA segment中的内容。initializers开始动态调整，在堆和堆栈中写入内容。那么可以<code>通过减少class、selector数量</code>、<code>延迟+load()</code>的方式来优化main()之前的加载过程。</p>
<p><strong>1、删除冗余代码</strong><br>思路：删除无用class、selector、冗余的功能库，减少静态调整（fix-up）的耗时。<br>原因：减少 <code>__DATA</code>段中的指针数量，就会减少静态调整的耗时（rebase/bind、class setup）。<br>操作：看可参考“app瘦身之删代码”。</p>
<p>Q：如何删除app中无用的 selector？<br>A：<a href="https://github.com/nst/objc_cover" target="_blank" rel="noopener">objc_cover</a> 通过对Mach-O文件的了解，可以知道<code>__TEXT:__objc_methname:</code>中包含了代码中的所有方法，而<code>__DATA:__objc_selrefs:</code>中则包含了所有被使用的方法的引用，通过取两个集合的差集就可以得到所有未被使用的代码</p>
<p>Q：如何统计main()之前的耗时?<br>A：苹果官方提供了一种方法，那就是在真机调试的时候勾选 dyld_PRINT_STATISTICS，就会对耗时详情打印出来。</p>
<p><strong>2、延时+load()</strong><br>+load()中一般为<code>swizzle method &amp; 路由注册</code>，我们可以延时其中的逻辑。<br>Q：如何延时，总不能把所有的+load()中的逻辑都放到自己的所在的class的init中吧？<br>A：当然不是，因为你可能需要在比 init()更早的时机执行+load()里的逻辑。<br>思路：</p>
<ol>
<li>把+load()中的逻辑抽离到一个普通方法中，比如：<code>+preLoad()</code>。</li>
<li>通过编译器提供<code>__attribute</code>，把该方法注册到<code>可执行文件</code>中的<code>__DATA段中的自定义section中</code>，其中存储方式大概为<code>key（方法名）:value（方法地址）</code>,注意这里的section中包含着当前app中所有的<code>key:value</code>。</li>
<li>在合适的时机，通过系统API读取section中的值，并执行指定方法。这里的合适时机指：如果当前preLoad()中的逻辑可以放到<code>首页渲染完成</code>之后执行，那么可以声明当前preLoad()的执行时机为<code>loadAfterRender</code>，这样就做到了原来的+load()的延时。这种应用场景一般为<code>路由注册</code>，因为一般首页渲染成功之前，不会跳转到其他页面。如果+load()中的逻辑必须要在main()之前执行，那么就保持+load()，而不用抽离到preLoad()中。</li>
</ol>
<p>小结：我们通过技术知识点提前获得把main()之前的方法，并根据具体业务逻辑来切换执行时机。</p>
<blockquote>
<p>通过<code>__attribute</code>把方法注册到<code>可执行文件</code>中的技术已在各大公司应用：<a href="https://github.com/alibaba/BeeHive" target="_blank" rel="noopener">阿里巴巴的 BeeHive</a> 与 美团Kylin（目前为内部工具）。</p>
</blockquote>
<h3 id="梳理didFinishLaunch"><a href="#梳理didFinishLaunch" class="headerlink" title="梳理didFinishLaunch"></a>梳理didFinishLaunch</h3><p>main()之后很多业务逻辑都集中在<code>didFinishLaunchingWithOptions()</code>中，我们梳理该方法后，发现其优化点分为三类，如下：</p>
<p><strong>1、启动项</strong><br>发现其中存在各种类型的启动项，主要分为：<br>（1）必须的：Crash SDK、数据统计SDK、网络配置<br>（2）可延迟的：与各个业务方PM、RD讨论一下是否可以延迟或懒加载非首页业务的启动项，比如支付SDK、页面性能监控SDK<br>（3）冗余的：对于一些已经下线的业务，删减冗余代码。</p>
<p><strong>2、数据查询</strong><br>（1）推迟&amp;减少对DB的操作<br>（2）数据库查询优化：分数据库，以资源换时间；在表中适当加<code>索引</code>。</p>
<p><strong>3、网络请求</strong><br>主要为：推迟&amp;减少请求、请求合并</p>
<h3 id="首页构建"><a href="#首页构建" class="headerlink" title="首页构建"></a>首页构建</h3><p>首页构建应该是我们比较熟悉的，因为其构建的过程就是一个普通 UIViewController从init()到viewDidLoad()以及viewWillAppear()的过程，那么优化的点有哪些呢？<br><strong>1、耗时操作</strong>：
（1）放在后台线程，避免阻塞主线程。比如：数据源的整合，开子线程操作，结束后同步到主线程并刷新UI。<br>（2）选择合适的API。比如获取一个文件的大小，如果使用OC的方式解决读取文件并得到length是很耗时的，我们可以通过使用C语言提供的API获取文件的大小（不读取整个文件，查询文件偏移量），速度更快。<br><strong>2、串行操作</strong>：尽量改为并行操作，减少任务等待。<br>比如：正常逻辑为在定位成功后根据定位信息进行网络请求。优化后为获取定位同时使用上一次缓存的定位信息进行网络请求，如果本次定位的结果与缓存一致，那么我们节约了一些网络请求的时间。</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>优化app启动就是让app启动的时候少做些事情，一般就是通过推迟&amp;减少耗时操作以及结合业务利用缓存等让app首页尽快的显示出来。</p>
<p>后续规划：<br>1、梳理app启动过程中的各种启动项，并做分类。比如LoadStagePreMain、LoadStageInLauch、LoadStageAfterRender…，并敦促RD执行。<br>2、监控灰度期间每个版本的启动耗时，及早的发现问题并解决问题。<br>3、统一基础服务，避免重复功能的的静态库、自定义class&amp;selector。</p>
<p>参考：<br><a href="https://tech.meituan.com/waimai_ios_optimizing_startup.html" target="_blank" rel="noopener">美团外卖iOS App冷启动治理</a><br><a href="https://techblog.toutiao.com/2017/01/17/iosspeed/" target="_blank" rel="noopener">今日头条iOS客户端启动速度优化</a><br><a href="https://juejin.im/entry/59985a32518825242860f59a" target="_blank" rel="noopener">阿里数据iOS端启动速度优化的一些经验</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/02/20180902前端渲染-服务端渲染/" rel="next" title="前端渲染&服务端渲染">
                <i class="fa fa-chevron-left"></i> 前端渲染&服务端渲染
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTMzNy81OTA1"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">wangdetong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、分析"><span class="nav-number">1.</span> <span class="nav-text">一、分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、优化"><span class="nav-number">2.</span> <span class="nav-text">二、优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-之前"><span class="nav-number">2.1.</span> <span class="nav-text">main()之前</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#梳理didFinishLaunch"><span class="nav-number">2.2.</span> <span class="nav-text">梳理didFinishLaunch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#首页构建"><span class="nav-number">2.3.</span> <span class="nav-text">首页构建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、总结"><span class="nav-number">3.</span> <span class="nav-text">三、总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangdetong</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

</body>
</html>
